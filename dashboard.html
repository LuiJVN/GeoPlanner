<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoPlanner - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="css/dashboard.css" />
    <link rel="stylesheet" href="bootstrap-icons/bootstrap-icons.min.css" />
</head>

<body>

    <header class="d-flex justify-content-between align-items-center">
        <a href="dashboard.html" class="d-flex align-items-center gap-2 text-white text-decoration-none">
            <img src="img/LogoMini.png" alt="Logo" style="width: 36px;" />
            <strong class="fs-5">GeoPlanner</strong>
        </a>
        <div class="search-bar position-relative" style="min-width: 300px;">
            <div class="input-group">
                <input type="text" id="address-search-input" class="form-control"
                    placeholder="Buscar direcci√≥n o lugar..." autocomplete="off" />
                <button id="address-search-btn" class="btn btn-primary" type="button">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            <div id="address-suggestions" class="list-group position-absolute w-100" style="z-index: 3000; top: 100%;">
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <button id="view-toggle-btn" class="btn btn-outline-light btn-sm">Ver Feed Cl√°sico</button>
            <div class="icon-bar d-flex gap-2">
                <span class="icon-button" id="theme-selector-icon" title="Cambiar Tema">üé®</span>
                <div class="dropdown-content" id="theme-selector-dropdown">
                    <div class="dropdown-header">Seleccionar Tema</div>
                    <div class="theme-item active" data-theme="default">
                        <div class="theme-preview" data-theme="default"></div>
                        <div>
                            <strong>Predeterminado</strong>
                            <br><small>Azul cl√°sico</small>
                        </div>
                    </div>
                    <div class="theme-item" data-theme="aurora">
                        <div class="theme-preview" data-theme="aurora"></div>
                        <div>
                            <strong>Aurora</strong>
                            <br><small>Rosa y azul</small>
                        </div>
                    </div>
                    <div class="theme-item" data-theme="noche">
                        <div class="theme-preview" data-theme="noche"></div>
                        <div>
                            <strong>Noche</strong>
                            <br><small>Modo oscuro</small>
                        </div>
                    </div>
                    <div class="theme-item" data-theme="oceano">
                        <div class="theme-preview" data-theme="oceano"></div>
                        <div>
                            <strong>Oc√©ano</strong>
                            <br><small>Azul marino</small>
                        </div>
                    </div>
                    <div class="theme-item" data-theme="amanecer">
                        <div class="theme-preview" data-theme="amanecer"></div>
                        <div>
                            <strong>Amanecer</strong>
                            <br><small>Naranja y rojo</small>
                        </div>
                    </div>
                    <div class="theme-item" data-theme="pastel">
                        <div class="theme-preview" data-theme="pastel"></div>
                        <div>
                            <strong>Pastel</strong>
                            <br><small>Azul suave</small>
                        </div>
                    </div>
                    <div class="theme-item" data-theme="fuego">
                        <div class="theme-preview" data-theme="fuego"></div>
                        <div>
                            <strong>Fuego</strong>
                            <br><small>Rojo intenso</small>
                        </div>
                    </div>
                    <div class="theme-item" data-theme="bosque">
                        <div class="theme-preview" data-theme="bosque"></div>
                        <div>
                            <strong>Bosque</strong>
                            <br><small>Verde natural</small>
                        </div>
                    </div>
                    <div class="theme-item" data-theme="lluvia">
                        <div class="theme-preview" data-theme="lluvia"></div>
                        <div>
                            <strong>Lluvia</strong>
                            <br><small>Azul el√©ctrico</small>
                        </div>
                    </div>
                </div>

                <span class="icon-button" id="map-styles-icon" title="Estilos de Mapa">üó∫Ô∏è</span>

                <div class="dropdown-content" id="map-styles-dropdown">
                    <div class="dropdown-header">Estilos de Mapa</div>
                    <div class="map-style-item active" data-style="openstreetmap">
                        <div class="map-style-preview"
                            style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA2MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjJGMkYyIi8+CjxwYXRoIGQ9Ik0xMCAzMEwyMCAyMEwzMCAzMEw0MCAyMEw1MCAzMCIgc3Ryb2tlPSIjQ0NDIiBzdHJva2Utd2lkdGg9IjIiLz4KPC9zdmc+')">
                        </div>
                        <div>
                            <strong>OpenStreetMap</strong>
                            <br><small>Mapa est√°ndar con calles</small>
                        </div>
                    </div>
                    <div class="map-style-item" data-style="satellite">
                        <div class="map-style-preview"
                            style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA2MCA0MCIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjNEE5MDQyIi8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjE1IiBoZWlnaHQ9IjE1IiBmaWxsPSIjNjhCMDVGIi8+CjxyZWN0IHg9IjM1IiB5PSIxNSIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjOEFEMDgxIi8+Cjwvc3ZnPg==')">
                        </div>
                        <div>
                            <strong>Vista Satelital</strong>
                            <br><small>Im√°genes satelitales</small>
                        </div>
                    </div>
                    <div class="map-style-item" data-style="hybrid_esri">
                        <div class="map-style-preview"
                            style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA2MCA0MCIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjNEE5MDQyIi8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjE1IiBoZWlnaHQ9IjE1IiBmaWxsPSIjNjhCMDVGIi8+CjxyZWN0IHg9IjM1IiB5PSIxNSIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjOEFEMDgxIi8+CjxyZWN0IHg9IjAiIHk9IjIwIiB3aWR0aD0iNjAiIGhlaWdodD0iMjAiIGZpbGw9InVybCgjY2hlY2tlcmJvYXJkKSIvPgo8cGF0aCBkPSJNMTAgMjVMMjAgMTVMMzAgMjVMMTggMzlIMTJDMTQgMzcgMTYgMzMgMTggMjUiIHN0cm9rZT0iIzc2Njc2NyIgc3Ryb2tlLXdpZHRoPSIxLjUiLz4KPC9zdmc+')">
                        </div>
                        <div>
                            <strong>Sat√©lite con Calles</strong>
                            <br><small>Im√°genes + calles</small>
                        </div>
                    </div>
                </div>

                <span class="icon-button" id="notifications-icon" title="Notificaciones">üîî</span>
                <div class="dropdown-content" id="notifications-dropdown">
                    <div class="dropdown-header">Notificaciones</div>
                    <a href="#" class="dropdown-item-custom">
                        <img src="img/estudio.jpg" alt="event">
                        <div><strong>@carlos_martinez</strong> coment√≥ en tu publicaci√≥n.</div>
                    </a>
                </div>

                <span class="icon-button" id="profile-icon" title="Perfil">üë§</span>
                <div class="dropdown-content" id="profile-dropdown">
                    <a href="perfil.html" class="dropdown-item-custom">
                        <img class="foto-usuario" src="img/placeholder.png" alt="profile">
                        <div>
                            <span class="nombre-usuario">Usuario</span>
                            <svg class="geoplanner-verified-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path
                                    d="M12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm5.71,7.29-6,6a1,1,0,0,1-1.42,0l-3-3a1,1,0,0,1,1.42-1.42L11,13.59l5.29-5.3a1,1,0,0,1,1.42,1.42Z" />
                            </svg>
                            <br>
                            <small>Ver tu perfil</small>
                        </div>
                    </a>
                    <hr class="my-2">
                    <a href="index.html" class="dropdown-item-custom" id="logout-button">
                        <span>‚û°Ô∏è</span>
                        <div><strong>Cerrar sesi√≥n</strong></div>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="main-content">
        <div class="sidebar-column">
            <aside class="left-sidebar">
                <ul>
                    <li id="menu-agenda">üìÖ Mi Agenda</li>
                    <li id="menu-inscripciones">üéüÔ∏è Mis Inscripciones</li>
                    <li id="menu-guardados">‚≠ê Eventos Guardados</li>
                    <li>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Grupos</li>
                </ul>
            </aside>
            <aside class="left-sidebar-down" id="map-filter-type">
                <ul>
                    <li id="1">Todos los tipos</li>
                    <li id="2">Deporte</li>
                    <li id="3">Estudio</li>
                    <li id="4">Social</li>
                    <li id="5">Cultural</li>
                    <li id="6">Otro</li>
                </ul>
            </aside>
        </div>
        <div class="content-area">
            <div id="map-view-container">
                <div id="feed-map">
                    <!-- Bot√≥n flotante para crear publicaci√≥n -->
                    <button id="floating-create-post-btn" class="btn btn-primary shadow-lg"
                        style="position: absolute; bottom: 24px; right: 24px; z-index: 1050;" title="Crear publicaci√≥n">
                        <span class="floating-btn-icon"><i class="bi bi-plus-lg"></i></span>
                        <span class="floating-btn-text">Crear Publicaci√≥n</span>
                    </button>
                    <!-- Bot√≥n flotante para centrar mapa en la ubicaci√≥n del usuario -->
                    <button id="center-map-btn" class="btn btn-light shadow"
                        style="position: absolute; bottom: 96px; right: 28px; z-index: 1050; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;"
                        title="Centrar en mi ubicaci√≥n">
                        <i class="bi bi-crosshair"></i>
                    </button>
                </div>
                <div id="event-detail-sidebar"></div>
                <!-- El bot√≥n de cerrar se agrega din√°micamente en el JS -->
            </div>
            <div id="classic-feed-container">
                <div id="classic-feed-view">
                    <div class="create-post-widget">
                        <div class="d-flex align-items-center gap-2">
                            <img src="img/placeholder.png" class="foto-usuario" alt="user"
                                style="width: 40px; height: 40px; border-radius: 50%;">
                            <div class="create-post-widget-input" data-bs-toggle="modal"
                                data-bs-target="#create-post-modal">
                                ¬øQu√© est√°s organizando, <span class="nombre-usuario-short">Usuario</span>?
                            </div>
                        </div>
                    </div>
                    <div id="classic-feed-content"></div>
                </div>
            </div>
        </div>
    </div>

    <button class="new-post-button" data-bs-toggle="modal" data-bs-target="#create-post-modal">+</button>

    <!-- Modal: Crear Nueva Publicaci√≥n -->
    <div class="modal fade" id="create-post-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Crear Nueva Publicaci√≥n</h5>
                    <button class="btn btn-sm btn-outline-primary" id="generate-ideas-btn">Generar Ideas ‚ú®</button>
                </div>
                <div class="modal-body">
                    <form id="create-post-form">
                        <div class="input-group mb-3">
                            <textarea id="post-text" class="form-control" rows="3"
                                placeholder="¬øQu√© est√°s organizando?..."></textarea>
                            <button class="btn btn-outline-secondary" type="button" id="enhance-text-btn"
                                title="Mejorar texto con IA">‚ú®</button>
                        </div>
                        <div id="idea-suggestions" class="mb-3"></div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <select class="form-select" id="post-type">
                                    <option>Social</option>
                                    <option>Deporte</option>
                                    <option>Estudio</option>
                                    <option>Cultural</option>
                                    <option>Otro</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <input type="datetime-local" id="post-date" class="form-control">
                            </div>
                            <div class="col-md-4 mb-3">
                                <select class="form-select" id="post-privacy">
                                    <option value="publica">P√∫blica</option>
                                    <option value="amigos">Solo amigos</option>
                                    <option value="privada">Privada con invitaci√≥n</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <input type="file" id="file-media" class="form-control" accept="image/*" />
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="modal"
                                data-bs-target="#map-select-modal">
                                üìç Seleccionar Ubicaci√≥n
                            </button>
                            <div id="location-display" class="mt-2">No se ha seleccionado ninguna ubicaci√≥n.</div>
                        </div>

                        <!-- SECCI√ìN DE T√âRMINOS Y CONDICIONES -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">T√©rminos y Condiciones del Evento</label>

                            <!-- Opci√≥n 1: T√©rminos Predeterminados -->
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="terms-option"
                                    id="terms-default-radio" value="default" checked>
                                <label class="form-check-label" for="terms-default-radio">
                                    Usar T√©rminos y Condiciones de GeoPlanner
                                </label>
                            </div>
                            <div class="p-2 mt-1 mb-2 border rounded bg-light"
                                style="font-size: 0.8rem; max-height: 150px; overflow-y: auto;">
                                <strong>Al seleccionar esta opci√≥n, aceptas y aplicas los siguientes t√©rminos a tu
                                    evento:</strong>
                                <p class="mt-1 mb-0 small"><strong>1. Responsabilidad Exclusiva del
                                        Organizador:</strong> Usted es el √∫nico responsable de la legalidad, seguridad
                                    (permisos, control de multitudes, etc.) y contenido de su evento.</p>
                                <p class="mt-1 mb-0 small"><strong>2. Deslinde de GeoPlanner:</strong> GeoPlanner es
                                    solo una plataforma tecnol√≥gica y no se hace responsable por ning√∫n incidente, da√±o
                                    o consecuencia legal relacionada con el evento.</p>
                                <p class="mt-1 mb-0 small"><strong>3. Prohibiciones Estrictas:</strong> Se proh√≠ben
                                    terminantemente eventos con actividades ilegales, armas, sustancias il√≠citas,
                                    violencia o discursos de odio.</p>
                                <p class="mt-1 mb-0 small"><strong>4. Cooperaci√≥n con Autoridades:</strong> Al publicar,
                                    confirma que su identidad fue verificada y acepta que su informaci√≥n puede ser
                                    compartida con las autoridades si se detecta alguna ilegalidad.</p>
                                <p class="mt-1 mb-0 small"><strong>Al publicar, declara que ha le√≠do y aceptado estos
                                        t√©rminos.</strong></p>
                            </div>

                            <!-- Opci√≥n 2: T√©rminos Personalizados -->
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="terms-option" id="terms-custom-radio"
                                    value="custom">
                                <label class="form-check-label" for="terms-custom-radio">
                                    Usar T√©rminos y Condiciones Personalizados (Bajo tu propio riesgo)
                                </label>
                            </div>
                            <textarea id="custom-terms-textarea" class="form-control mt-2" rows="3"
                                placeholder="Define tus propias reglas y condiciones. Recuerda que eres el √∫nico responsable legal de tu evento."
                                style="display: none;"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="publish-button">Publicar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Seleccionar Ubicaci√≥n -->
    <div class="modal fade" id="map-select-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Define la ubicaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" data-bs-target="#create-post-modal"
                        data-bs-toggle="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="simple-route-tab">üìç Ruta Simple</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="multiple-route-tab">‚ûØ Ruta M√∫ltiple</button>
                        </li>
                    </ul>
                    <p class="form-text mt-2">
                        <strong>Ruta Simple:</strong> Un √∫nico marcador.<br>
                        <strong>Ruta M√∫ltiple:</strong> Traza una ruta con varios puntos.
                    </p>
                    <div class="mb-3 position-relative" id="modal-search-bar-container">
                        <div class="input-group">
                            <input type="text" id="modal-address-search-input" class="form-control"
                                placeholder="Buscar direcci√≥n o lugar..." autocomplete="off" />
                            <button id="modal-address-search-btn" class="btn btn-primary" type="button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <div id="modal-address-suggestions" class="list-group position-absolute w-100"
                            style="z-index: 3000; top: 100%;"></div>
                    </div>
                    <div id="modal-map-container"></div>
                    <div id="ruta-inputs" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" id="clear-map-button">Limpiar Mapa</button>
                    <button type="button" class="btn btn-primary" id="accept-location-button">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Agenda -->
    <div class="modal fade" id="agenda-modal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mi Agenda Privada</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Nueva Actividad</h6>
                            <form id="agenda-form">
                                <div class="mb-2"><input type="text" id="agenda-title" class="form-control"
                                        placeholder="T√≠tulo de la actividad" required></div>
                                <div class="mb-2"><textarea id="agenda-desc" class="form-control" rows="3"
                                        placeholder="Descripci√≥n..."></textarea></div>
                                <div class="mb-2"><input type="datetime-local" id="agenda-date" class="form-control"
                                        required></div>
                                <button type="submit" class="btn btn-primary w-100">Guardar Actividad</button>
                            </form>
                        </div>
                        <div class="col-md-8">
                            <h6>Mis Actividades</h6>
                            <div id="agenda-list" class="list-group"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Eventos Guardados -->
    <div class="modal fade" id="saved-events-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mis Eventos Guardados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="saved-events-list"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // --- GLOBAL VARIABLES & CONSTANTS ---
            const STORAGE_KEY_POSTS = 'geoplanner_posts';
            const STORAGE_KEY_AGENDA = 'geoplanner_agenda_';
            const STORAGE_KEY_SAVED = 'geoplanner_saved_';
            let currentUser = JSON.parse(sessionStorage.getItem('currentUser')) || {};
            const USER_ID = currentUser.nombreUsuario || 'invitado';

            let mainMap, selectionMap, selectionPolyline;
            let selectedMarkers = [];
            let routeType = 'simple';
            let currentView = 'map';
            let allPosts = [];
            let agendaItems = [];
            let savedEvents = [];
            let currentMapStyle = 'openstreetmap';
            let currentTileLayer = null;
            let userRegistrations = [];


            // NUEVAS VARIABLES PARA FUNCIONALIDADES AGREGADAS
            let userLocationMarker = null;
            let userLocation = null;
            let routingControl = null;

            // --- CENTRAR MAPA EN UBICACI√ìN DEL USUARIO ---
            const centerMapBtn = document.getElementById('center-map-btn');
            if (centerMapBtn) {
                centerMapBtn.addEventListener('click', function () {
                    if (mainMap && userLocation) {
                        mainMap.setView([userLocation.lat, userLocation.lng], mainMap.getZoom(), { animate: true });
                    } else {
                        alert('Ubicaci√≥n de usuario no disponible.');
                    }
                });
            }

            const createPostModal = new bootstrap.Modal(document.getElementById('create-post-modal'));
            const agendaModal = new bootstrap.Modal(document.getElementById('agenda-modal'));
            const savedEventsModal = new bootstrap.Modal(document.getElementById('saved-events-modal'));

            const mapStyles = {
                openstreetmap: {
                    name: 'OpenStreetMap',
                    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    attribution: '¬© OpenStreetMap contributors'
                },
                satellite: {
                    name: 'Vista Satelital',
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    attribution: '¬© Esri'
                },
                hybrid_esri: {
                    name: 'Sat√©lite con Calles (Esri)',
                    // URL de la capa satelital base de Esri
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    attribution: '¬© Esri',
                }
            };


            // --- THEME LOGIC ---
            const temas = {
                default: {
                    headerBG: "linear-gradient(145deg, #007BFF, #003366)",
                    headerText: "white",
                    bodyBG: "#f0f2f5",
                    sidebarBG: "linear-gradient(145deg, #007BFF, #003366)",
                    sidebarText: "white",
                    cardBG: "#ffffff",
                    cardText: "#333",
                    btnPrimaryBG: "#00bfff"
                },
                aurora: {
                    headerBG: "linear-gradient(145deg, #F8CDDA, #1D2B64)",
                    headerText: "#FFFFFF",
                    bodyBG: "#fdeff2",
                    sidebarBG: "linear-gradient(145deg, #F8CDDA, #1D2B64)",
                    sidebarText: "#FFFFFF",
                    cardBG: "#ffffff",
                    cardText: "#1D2B64",
                    btnPrimaryBG: "#1D2B64"
                },
                noche: {
                    headerBG: "linear-gradient(145deg, #141E30, #243B55)",
                    headerText: "white",
                    bodyBG: "#0f172a",
                    sidebarBG: "linear-gradient(145deg, #141E30, #243B55)",
                    sidebarText: "white",
                    cardBG: "#1e293b",
                    cardText: "#e2e8f0",
                    btnPrimaryBG: "#38bdf8"
                },
                oceano: {
                    headerBG: "linear-gradient(145deg, #2C3E50, #4CA1AF)",
                    headerText: "white",
                    bodyBG: "#eef6f7",
                    sidebarBG: "linear-gradient(145deg, #2C3E50, #4CA1AF)",
                    sidebarText: "white",
                    cardBG: "#ffffff",
                    cardText: "#2C3E50",
                    btnPrimaryBG: "#4CA1AF"
                },
                amanecer: {
                    headerBG: "linear-gradient(145deg, #FF512F, #F09819)",
                    headerText: "white",
                    bodyBG: "#fff8f2",
                    sidebarBG: "linear-gradient(145deg, #FF512F, #F09819)",
                    sidebarText: "white",
                    cardBG: "#ffffff",
                    cardText: "#5c2a07",
                    btnPrimaryBG: "#FF512F"
                },
                pastel: {
                    headerBG: "linear-gradient(145deg, #A1C4FD, #C2E9FB)",
                    headerText: "#003366",
                    bodyBG: "#f5f9ff",
                    sidebarBG: "linear-gradient(145deg, #A1C4FD, #C2E9FB)",
                    sidebarText: "#003366",
                    cardBG: "#ffffff",
                    cardText: "#333",
                    btnPrimaryBG: "#A1C4FD"
                },
                fuego: {
                    headerBG: "linear-gradient(145deg, #CB356B, #BD3F32)",
                    headerText: "white",
                    bodyBG: "#f9f2f3",
                    sidebarBG: "linear-gradient(145deg, #CB356B, #BD3F32)",
                    sidebarText: "white",
                    cardBG: "#ffffff",
                    cardText: "#4d1024",
                    btnPrimaryBG: "#CB356B"
                },
                bosque: {
                    headerBG: "linear-gradient(145deg, #11998E, #38EF7D)",
                    headerText: "white",
                    bodyBG: "#f2fcf8",
                    sidebarBG: "linear-gradient(145deg, #11998E, #38EF7D)",
                    sidebarText: "white",
                    cardBG: "#ffffff",
                    cardText: "#043d38",
                    btnPrimaryBG: "#11998E"
                },
                lluvia: {
                    headerBG: "linear-gradient(145deg, #396afc, #2948ff)",
                    headerText: "white",
                    bodyBG: "#f0f2ff",
                    sidebarBG: "linear-gradient(145deg, #396afc, #2948ff)",
                    sidebarText: "white",
                    cardBG: "#ffffff",
                    cardText: "#192d8b",
                    btnPrimaryBG: "#396afc"
                }
            };

            // 2. Funci√≥n para aplicar el tema
            function applyTheme(themeName) {
                const root = document.documentElement;
                const theme = temas[themeName] || temas.noche; // Usar 'noche' como predeterminado si no se encuentra

                root.style.setProperty('--header-bg', theme.headerBG);
                root.style.setProperty('--header-text-color', theme.headerText);
                root.style.setProperty('--header-icon-bg', theme.headerIconBG);
                root.style.setProperty('--header-icon-hover-bg', `rgba(255, 255, 255, 0.25)`);

                root.style.setProperty('--body-bg', theme.bodyBG);

                root.style.setProperty('--sidebar-bg', theme.sidebarBG);
                root.style.setProperty('--sidebar-text-color', theme.sidebarText);
                root.style.setProperty('--sidebar-hover-bg', `rgba(255, 255, 255, 0.15)`);

                root.style.setProperty('--card-bg', theme.cardBG);
                root.style.setProperty('--card-text-color', theme.cardText);

                root.style.setProperty('--btn-primary-bg', theme.btnPrimaryBG);
                root.style.setProperty('--btn-primary-text', theme.headerText); // A menudo el texto del bot√≥n coincide con el del header

                // Actualizar la UI del selector de temas
                document.querySelectorAll('.theme-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.theme === themeName) {
                        item.classList.add('active');
                    }
                });

                // Guardar el tema seleccionado
                localStorage.setItem('geoPlannerTema', themeName);
            }

            // FUNCIONES PARA UBICACI√ìN DEL USUARIO Y C√ÅLCULO DE DISTANCIA

            // Funci√≥n para crear el icono personalizado del usuario usando el logo
            function createUserLocationIcon(zoomLevel) {
                // Calcular el tama√±o del icono basado en el nivel de zoom
                let iconSize = Math.max(20, Math.min(50, zoomLevel * 3));

                return L.divIcon({
                    html: `<img src="img/LogoMini.png" style="width: ${iconSize}px; height: ${iconSize}px; border-radius: 50%; border: 3px solid #007BFF; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);" alt="Tu ubicaci√≥n">`,
                    className: 'user-location-marker',
                    iconSize: [iconSize, iconSize],
                    iconAnchor: [iconSize / 2, iconSize / 2]
                });
            }

            // Funci√≥n para obtener la ubicaci√≥n actual del usuario
            function getUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function (position) {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            // Agregar marcador de ubicaci√≥n del usuario al mapa principal
                            addUserLocationToMap();
                        },
                        function (error) {
                            console.warn('No se pudo obtener la ubicaci√≥n del usuario:', error);
                            // Usar ubicaci√≥n por defecto (Maracaibo, Venezuela)
                            userLocation = {
                                lat: 10.654,
                                lng: -71.612
                            };
                            addUserLocationToMap();
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000 // 5 minutos
                        }
                    );
                } else {
                    console.warn('Geolocalizaci√≥n no soportada por este navegador');
                    // Usar ubicaci√≥n por defecto
                    userLocation = {
                        lat: 10.654,
                        lng: -71.612
                    };
                    addUserLocationToMap();
                }
            }

            // Funci√≥n para agregar el marcador del usuario al mapa
            function addUserLocationToMap() {
                if (!mainMap || !userLocation) return;

                // Remover marcador anterior si existe
                if (userLocationMarker) {
                    mainMap.removeLayer(userLocationMarker);
                }

                // Crear nuevo marcador con el logo
                const currentZoom = mainMap.getZoom();
                userLocationMarker = L.marker([userLocation.lat, userLocation.lng], {
                    icon: createUserLocationIcon(currentZoom)
                }).addTo(mainMap);

                // Agregar popup informativo
                userLocationMarker.bindPopup('<b>Tu ubicaci√≥n actual</b><br>¬°Aqu√≠ est√°s t√∫!');

                // Actualizar el tama√±o del icono cuando cambie el zoom
                mainMap.on('zoomend', function () {
                    if (userLocationMarker) {
                        const newZoom = mainMap.getZoom();
                        userLocationMarker.setIcon(createUserLocationIcon(newZoom));
                    }
                });
            }

            // Funci√≥n para calcular la distancia entre dos puntos (f√≥rmula de Haversine)
            function calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371; // Radio de la Tierra en kil√≥metros
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng / 2) * Math.sin(dLng / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const distance = R * c;
                return distance;
            }

            // Funci√≥n para formatear la distancia de manera legible
            function formatDistance(distanceKm) {
                if (distanceKm < 1) {
                    return `${Math.round(distanceKm * 1000)} metros`;
                } else if (distanceKm < 10) {
                    return `${distanceKm.toFixed(1)} km`;
                } else {
                    return `${Math.round(distanceKm)} km`;
                }
            }

            let currentOverlayLayer = null; // Variable para la capa de superposici√≥n de calles

            function changeMapStyle(styleName) {
                if (!mapStyles[styleName]) return;
                currentMapStyle = styleName;
                const style = mapStyles[styleName];

                // Limpiar capas existentes
                if (mainMap && currentTileLayer) {
                    mainMap.removeLayer(currentTileLayer);
                }
                if (mainMap && currentOverlayLayer) {
                    mainMap.removeLayer(currentOverlayLayer);
                    currentOverlayLayer = null;
                }
                if (selectionMap) {
                    selectionMap.eachLayer(layer => {
                        if (layer instanceof L.TileLayer) {
                            selectionMap.removeLayer(layer);
                        }
                    });
                }

                // A√±adir la capa base
                currentTileLayer = L.tileLayer(style.url, { attribution: style.attribution });
                if (mainMap) {
                    currentTileLayer.addTo(mainMap);
                }
                if (selectionMap) {
                    L.tileLayer(style.url, { attribution: style.attribution }).addTo(selectionMap);
                }

                // Si el estilo es 'hybrid_esri', a√±ade la capa de calles como superposici√≥n
                if (styleName === 'hybrid_esri') {
                    currentOverlayLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, TomTom, OpenStreetMap contributors',
                        pane: 'overlayPane' // Asegura que la capa de superposici√≥n est√© por encima
                    });
                    if (mainMap) {
                        currentOverlayLayer.addTo(mainMap);
                        currentOverlayLayer.setZIndex(10); // Un z-index m√°s alto para que est√© encima
                    }
                    if (selectionMap) {
                        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
                            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, TomTom, OpenStreetMap contributors',
                            pane: 'overlayPane'
                        }).addTo(selectionMap).setZIndex(10);
                    }
                }

                // Actualizar UI
                document.querySelectorAll('.map-style-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.style === styleName) {
                        item.classList.add('active');
                    }
                });

                // Guardar preferencia
                localStorage.setItem('geoplanner_map_style', styleName);
            }


            // --- DATA INITIALIZATION & MANAGEMENT ---
            function initData() {
                // Cargar y mostrar datos del usuario desde localStorage
                const nombre = localStorage.getItem("geoPlannerNombre") || "Usuario";
                const apellido = localStorage.getItem("geoPlannerApellido") || "";
                const foto = localStorage.getItem("geoPlannerFotoPerfil");
                const tema = localStorage.getItem("geoPlannerTema") || "default";

                // Actualizar el objeto currentUser para la l√≥gica interna (como USER_ID)
                currentUser.nombre = `${nombre} ${apellido}`.trim();
                currentUser.foto = foto;

                // Actualizar nombre en el perfil y en el widget de creaci√≥n
                document.querySelector('.nombre-usuario').textContent = currentUser.nombre;
                document.querySelector('.nombre-usuario-short').textContent = nombre.split(' ')[0];

                // Actualizar foto de perfil en todos los elementos relevantes
                if (foto) {
                    document.querySelectorAll(".foto-usuario").forEach(el => {
                        el.src = foto;
                    });
                }

                // Load saved map style
                const savedMapStyle = localStorage.getItem('geoplanner_map_style') || 'openstreetmap';
                currentMapStyle = savedMapStyle;

                // Cargar publicaciones, agenda y eventos guardados
                const examplePosts = [{
                    id: 'post_1',
                    author: 'ana_gomez',
                    verified: true,
                    text: '¬°Ma√±ana de senderismo en la monta√±a! Salimos a las 7 AM.',
                    privacidad: 'publica',
                    mediaURL: 'https://images.unsplash.com/photo-1551632811-561732d1e306?q=80&w=2070',
                    type: 'Deporte',
                    eventDate: '2025-07-15T07:00:00',
                    likes: 15,
                    likers: [],
                    comentarios: [{
                        author: 'carlos_ruiz',
                        text: '¬°All√° nos vemos!'
                    }],
                    rutas: [{
                        coords: '10.72,-71.65',
                        label: 'Entrada principal'
                    }],
                    terms: {
                        type: 'default',
                        text: ''
                    }
                }, {
                    id: 'post_8',
                    author: 'juan_sarcos',
                    verified: true,
                    text: '¬°Vamos al cine a ver el estreno del verano!',
                    privacidad: 'amigos',
                    mediaURL: 'https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=1975',
                    type: 'Social',
                    eventDate: '2025-08-02T20:00:00',
                    likes: 9,
                    likers: [USER_ID],
                    comentarios: [],
                    rutas: [{
                        coords: '10.69,-71.63',
                        label: 'Cinex Galer√≠as'
                    }],
                    terms: {
                        type: 'custom',
                        text: 'Comprar entradas con antelaci√≥n. Ser puntuales por favor.'
                    }
                }];
                if (!localStorage.getItem(STORAGE_KEY_POSTS)) {
                    localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(examplePosts));
                }
                allPosts = JSON.parse(localStorage.getItem(STORAGE_KEY_POSTS));
                agendaItems = JSON.parse(localStorage.getItem(STORAGE_KEY_AGENDA + USER_ID)) || [];
                savedEvents = JSON.parse(localStorage.getItem(STORAGE_KEY_SAVED + USER_ID)) || [];
                userRegistrations = JSON.parse(localStorage.getItem('geoplanner_registrations_' + USER_ID)) || [];

                // Aplicar el tema guardado
                applyTheme(tema);
            }

            // --- VIEW MANAGEMENT & RENDERING ---
            function toggleView() {
                currentView = (currentView === 'map') ? 'classic' : 'map';
                document.getElementById('view-toggle-btn').textContent = currentView === 'map' ? 'Ver Feed Cl√°sico' : 'Ver Vista de Mapa';
                document.getElementById('map-view-container').style.display = currentView === 'map' ? 'flex' : 'none';
                document.getElementById('classic-feed-container').style.display = currentView === 'classic' ? 'flex' : 'none';
                if (currentView === 'map') {
                    mainMap.invalidateSize();
                } else {
                    renderClassicFeed();
                }
            }

            function renderClassicFeed() {
                const feedContent = document.getElementById('classic-feed-content');
                feedContent.innerHTML = '';
                allPosts
                    .sort((a, b) => new Date(b.eventDate) - new Date(a.eventDate))
                    .forEach(post => feedContent.appendChild(renderPost(post)));
            }

            function renderPost(post) {
                // Asegurar que el array de inscritos existe
                if (!post.inscritos) post.inscritos = [];
                const container = document.createElement('div');
                container.className = 'post';

                const privacyBadge = {
                    publica: 'üîì P√∫blica',
                    amigos: 'üë• Amigos',
                    privada: 'üîí Privada'
                }[post.privacidad] || 'üîì P√∫blica';
                const isLiked = post.likers.includes(USER_ID);
                const isSaved = savedEvents.includes(post.id);
                const verifiedIcon = `<svg class="geoplanner-verified-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm5.71,7.29-6,6a1,1,0,0,1-1.42,0l-3-3a1,1,0,0,1,1.42-1.42L11,13.59l5.29-5.3a1,1,0,0,1,1.42,1.42Z"/></svg>`;
                const saveStarIcon = `<svg class="save-star-icon ${isSaved ? 'saved' : ''}" data-post-id="${post.id}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;

                const isOwner = post.author === USER_ID;
                const now = new Date();
                const eventDate = new Date(post.eventDate);
                let actionButton = '';
                if (isOwner) {
                    if (eventDate > now) {
                        actionButton = `<button class="btn btn-sm btn-warning btn-ver-inscritos" data-post-id="${post.id}">Ver Inscritos</button>`;
                    } else {
                        actionButton = `<button class="btn btn-sm btn-success btn-verificar-asistentes" data-post-id="${post.id}">Verificar Asistentes</button>`;
                    }
                } else {
                    actionButton = `<button class="btn btn-sm btn-primary btn-inscribirse" data-post-id="${post.id}">Inscribirse</button>`;
                }

                container.innerHTML = `
                    <div class="post-header">
                        <strong>${post.author}</strong>
                        ${post.verified ? verifiedIcon : ''}
                        <span class="badge bg-secondary">${privacyBadge}</span>
                        ${saveStarIcon}
                    </div>
                    <p>${post.text}</p>
                    ${post.mediaURL ? `<img src="${post.mediaURL}" alt="Media" class="img-fluid rounded mb-2" onerror="this.style.display='none'">` : ''}
                    <div class="map-container mb-2" id="map-${post.id}"></div>
                    ${post.rutas.length > 1 ? `<ol class="list-group list-group-flush list-group-numbered mb-2 small">${post.rutas.map(r => `<li class="list-group-item">${r.label}</li>`).join('')}</ol>` : ''}
                    <div class="d-flex gap-2 mt-2 flex-wrap">
                        <button class="btn btn-sm btn-outline-danger btn-like" data-post-id="${post.id}">
                            ${isLiked ? 'üíî Quitar Like' : '‚ù§Ô∏è Like'} (<span>${post.likes}</span>)
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#comentarios-${post.id}">
                            üí¨ Comentarios (${post.comentarios.length})
                        </button>
                        <button class="btn btn-sm btn-outline-info btn-terms" data-post-id="${post.id}">
                            üìú Ver T√©rminos
                        </button>
                        ${actionButton}
                    </div>
                    <div class="comentarios mt-2 collapse" id="comentarios-${post.id}">
                        <div class="comentarios-list mb-2 small">
                            ${post.comentarios.map(c => `<div><strong>@${c.author}:</strong> ${c.text}</div>`).join('') || 'No hay comentarios.'}
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control form-control-sm" placeholder="Escribe un comentario...">
                            <button class="btn btn-sm btn-primary btn-comment" data-post-id="${post.id}">Enviar</button>
                        </div>
                    </div>
                `;

                if (isOwner) {
                    container.innerHTML += `<button class="btn btn-sm btn-danger w-100 mt-2 btn-delete" data-post-id="${post.id}">üóëÔ∏è Eliminar Publicaci√≥n</button>`;
                }

                setTimeout(() => {
                    const mapElement = container.querySelector(`#map-${post.id}`);
                    if (mapElement && !mapElement.classList.contains('leaflet-container')) {
                        const latlngs = post.rutas.map(r => r.coords.split(',').map(Number));
                        const postMap = L.map(mapElement, {
                            zoomControl: false,
                            scrollWheelZoom: false
                        }).setView(latlngs[0], 13);

                        // Use current map style for post maps
                        const style = mapStyles[currentMapStyle];
                        L.tileLayer(style.url, {
                            attribution: style.attribution
                        }).addTo(postMap);

                        // Agregar marcadores de eventos p√∫blicos en color rojo
                        latlngs.forEach(latlng => {
                            // Crear icono rojo para eventos p√∫blicos
                            const eventIcon = L.divIcon({
                                html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><path fill="#dc3545" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>`,
                                className: 'public-event-marker',
                                iconSize: [28, 28],
                                iconAnchor: [14, 28],
                                popupAnchor: [0, -28],
                            });
                            L.marker(latlng, { icon: eventIcon }).addTo(postMap);
                        });

                        // Agregar marcador del usuario si est√° disponible
                        if (userLocation) {
                            const userIcon = createUserLocationIcon(13);
                            L.marker([userLocation.lat, userLocation.lng], {
                                icon: userIcon
                            }).addTo(postMap).bindPopup('Tu ubicaci√≥n');
                        }

                        if (latlngs.length > 1) {
                            const polyline = L.polyline(latlngs, {
                                color: '#007BFF'
                            }).addTo(postMap);
                            postMap.fitBounds(polyline.getBounds(), {
                                padding: [20, 20]
                            });
                        } else {
                            postMap.setView(latlngs[0], 15);
                        }
                    }
                }, 0);
                return container;
            }

            function renderSavedPost(post) {
                const container = document.createElement('div');
                container.className = 'post';
                container.innerHTML = `
                    <p>${post.text}</p>
                    <div class="map-container mb-2" id="map-saved-${post.id}"></div>
                `;
                setTimeout(() => {
                    const mapElement = container.querySelector(`#map-saved-${post.id}`);
                    if (mapElement && !mapElement.classList.contains('leaflet-container')) {
                        const latlngs = post.rutas.map(r => r.coords.split(',').map(Number));
                        const postMap = L.map(mapElement, {
                            zoomControl: false,
                            scrollWheelZoom: false
                        }).setView(latlngs[0], 13);

                        // Use current map style for saved post maps
                        const style = mapStyles[currentMapStyle];
                        L.tileLayer(style.url, {
                            attribution: style.attribution
                        }).addTo(postMap);

                        // Agregar marcadores de eventos p√∫blicos en color rojo
                        latlngs.forEach(latlng => {
                            const eventIcon = L.divIcon({
                                html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><path fill="#dc3545" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>`,
                                className: 'public-event-marker',
                                iconSize: [28, 28],
                                iconAnchor: [14, 28]
                            });
                            L.marker(latlng, { icon: eventIcon }).addTo(postMap);
                        });

                        // Agregar marcador del usuario si est√° disponible
                        if (userLocation) {
                            const userIcon = createUserLocationIcon(13);
                            L.marker([userLocation.lat, userLocation.lng], {
                                icon: userIcon
                            }).addTo(postMap).bindPopup('Tu ubicaci√≥n');
                        }

                        if (latlngs.length > 1) {
                            const polyline = L.polyline(latlngs, {
                                color: '#007BFF'
                            }).addTo(postMap);
                            postMap.fitBounds(polyline.getBounds(), {
                                padding: [20, 20]
                            });
                        } else {
                            postMap.setView(latlngs[0], 15);
                        }
                    }
                }, 0);
                return container;
            }

            function refreshUI() {
                renderClassicFeed();
                renderMapMarkers(document.getElementById('map-filter-type').value);
            }

            // --- INTERACTION LOGIC ---
            function toggleLike(postId) {
                const post = allPosts.find(p => p.id === postId);
                if (!post) return;
                const userIndex = post.likers.indexOf(USER_ID);
                if (userIndex > -1) {
                    post.likers.splice(userIndex, 1);
                    post.likes--;
                } else {
                    post.likers.push(USER_ID);
                    post.likes++;
                }
                localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(allPosts));
                refreshUI();
            }

            function addComment(postId, text) {
                const post = allPosts.find(p => p.id === postId);
                if (post && text) {
                    post.comentarios.push({
                        author: USER_ID,
                        text: text
                    });
                    localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(allPosts));
                    refreshUI();
                }
            }

            function eliminarPost(postId) {
                allPosts = allPosts.filter(p => p.id !== postId);
                localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(allPosts));
                refreshUI();
            }

            function toggleSaveEvent(postId) {
                const index = savedEvents.indexOf(postId);
                if (index > -1) {
                    savedEvents.splice(index, 1);
                } else {
                    savedEvents.push(postId);
                }
                localStorage.setItem(STORAGE_KEY_SAVED + USER_ID, JSON.stringify(savedEvents));
                refreshUI();
            }

            function handleSubscription(postId) {
                const post = allPosts.find(p => p.id === postId);
                if (!post) return;
                if (!post.inscritos) post.inscritos = [];
                if (userRegistrations.some(reg => reg.postId === postId)) {
                    alert('Ya est√°s inscrito en este evento.');
                    return;
                }
                if (post.inscritos.some(u => u.userId === USER_ID)) {
                    alert('Ya est√°s inscrito en este evento.');
                    return;
                }
                const confirmation = confirm('Al inscribirte, aceptas los t√©rminos y condiciones del evento. ¬øDeseas continuar?');
                if (confirmation) {
                    const registration = {
                        postId: post.id,
                        title: post.text,
                        author: post.author,
                        eventDate: post.eventDate,
                        registrationDate: new Date().toISOString(),
                        userId: USER_ID
                    };
                    userRegistrations.push(registration);
                    post.inscritos.push({ userId: USER_ID, nombre: currentUser.nombre || USER_ID });
                    localStorage.setItem('geoplanner_registrations_' + USER_ID, JSON.stringify(userRegistrations));
                    localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(allPosts));
                    alert('¬°Inscripci√≥n exitosa!');
                    refreshUI();
                }
            }

            // --- MAPS & MODALS LOGIC ---
            function initMainMap() {
                mainMap = L.map('feed-map').setView([10.654, -71.612], 12);

                // Apply saved map style
                const style = mapStyles[currentMapStyle];
                currentTileLayer = L.tileLayer(style.url, {
                    attribution: style.attribution
                }).addTo(mainMap);

                // Obtener y mostrar la ubicaci√≥n del usuario
                getUserLocation();
            }

            function markRouteOnMap(puntoInicio, puntoFinal) {
                // Nueva versi√≥n: acepta un array de puntos (waypoints)
                borrarRuta();
                let waypoints = [];
                // Si recibe un array de arrays, lo usamos directamente
                if (Array.isArray(puntoInicio) && Array.isArray(puntoInicio[0])) {
                    waypoints = puntoInicio.map(wp => L.latLng(wp[0], wp[1]));
                } else {
                    // Compatibilidad con la llamada antigua
                    waypoints = [L.latLng(puntoInicio), L.latLng(puntoFinal)];
                }
                if (waypoints.length < 2) {
                    console.log("Se necesitan al menos 2 puntos para trazar una ruta.");
                    return;
                }
                routingControl = L.Routing.control({
                    waypoints: waypoints,
                    createMarker: function() { return null; },
                }).addTo(mainMap);
            }

            function borrarRuta() {
                // Elimina el control de rutas si existe
                if (routingControl) {
                    mainMap.removeControl(routingControl);
                    routingControl = null;
                }
            }

            function renderMapMarkers(filterType = 'all') {
                // Limpiar marcadores existentes (excepto el del usuario)
                mainMap.eachLayer(layer => {
                    if (layer instanceof L.Marker && layer !== userLocationMarker) {
                        mainMap.removeLayer(layer);
                    }
                });

                // Filtrar solo eventos p√∫blicos
                const publicPosts = allPosts.filter(post => post.privacidad === 'publica');
                const filteredPosts = (filterType === 'all') ? publicPosts : publicPosts.filter(p => p.type === filterType);

                filteredPosts.forEach(post => {
                    if (post.rutas && post.rutas.length > 0) {
                        const latlng = post.rutas[0].coords.split(',').map(Number);

                        // Crear icono rojo para eventos p√∫blicos cercanos
                        const icon = L.divIcon({
                            html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"><path fill="#dc3545" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>`,
                            className: 'public-event-marker',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32],
                            popupAnchor: [0, -28]
                        });

                        const marker = L.marker(latlng, {
                            icon
                        }).addTo(mainMap);

                        marker.on('mouseover', () => marker.bindPopup(`<b>${post.text.substring(0, 30)}...</b><br><small>Evento p√∫blico</small>`).openPopup());
                        marker.on('mouseout', () => marker.closePopup());
                        marker.on('click', () => {
                            // Calcular distancia si tenemos la ubicaci√≥n del usuario
                            let distanceInfo = '';
                            if (userLocation) {
                                const distance = calculateDistance(
                                    userLocation.lat, userLocation.lng,
                                    latlng[0], latlng[1]
                                );
                                markRouteOnMap(userLocation, latlng);
                                distanceInfo = `<div class=\"mt-2 p-2 bg-info text-white rounded\"><strong>üìç Distancia desde tu ubicaci√≥n:</strong><br>${formatDistance(distance)}</div>`;
                            }

                            const detailSidebar = document.getElementById('event-detail-sidebar');
                            // Bot√≥n de cerrar
                            const closeBtn = `<button id=\"close-event-detail\" class=\"btn btn-sm btn-secondary mb-2\" style=\"float:right;\">Cerrar ‚úñ</button>`;
                            detailSidebar.innerHTML = closeBtn + `<div class=\"post\">${renderPost(post).innerHTML}${distanceInfo}</div>`;
                            detailSidebar.classList.add('show');
                            // Trazar la ruta m√∫ltiple si hay m√°s de un punto
                            let waypointMarkers = [];
                            if (post.rutas.length > 1) {
                                let allWaypoints = post.rutas.map(r => r.coords.split(',').map(Number));
                                // Si hay ubicaci√≥n del usuario, anteponerla a la ruta
                                let routeWaypoints = allWaypoints;
                                if (userLocation) {
                                    routeWaypoints = [[userLocation.lat, userLocation.lng], ...allWaypoints];
                                }
                                markRouteOnMap(routeWaypoints);
                                // Agregar marcadores solo si hay m√°s de dos puntos en la ruta original (sin la ubicaci√≥n del usuario)
                                if (post.rutas.length !== 1) {
                                    for (let i = 0; i < allWaypoints.length; i++) {
                                        const wp = allWaypoints[i];
                                        const marker = L.marker(wp, {
                                            icon: L.divIcon({
                                                className: 'waypoint-marker',
                                                html: `<div style='background:#fff;border:2px solid #007BFF;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#007BFF;'>${i+1}</div>`,
                                                iconSize: [18, 18],
                                                iconAnchor: [9, 9]
                                            })
                                        }).addTo(mainMap);
                                        waypointMarkers.push(marker);
                                    }
                                }
                            } else if (post.rutas.length === 1) {
                                // Ruta simple: desde la ubicaci√≥n del usuario hasta el punto de la publicaci√≥n
                                let point = post.rutas[0].coords.split(',').map(Number);
                                if (userLocation) {
                                    let waypoints = [[userLocation.lat, userLocation.lng], point];
                                    markRouteOnMap(waypoints);
                                } else {
                                    // Si no hay ubicaci√≥n del usuario, solo muestra el punto
                                    borrarRuta();
                                    const marker = L.marker(point, {
                                        icon: L.divIcon({
                                            className: 'waypoint-marker',
                                            html: `<div style='background:#fff;border:2px solid #007BFF;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#007BFF;'>1</div>` ,
                                            iconSize: [18, 18],
                                            iconAnchor: [9, 9]
                                        })
                                    }).addTo(mainMap);
                                    waypointMarkers.push(marker);
                                }
                            }
                            // Listener para cerrar
                            document.getElementById('close-event-detail').onclick = () => {
                                detailSidebar.classList.remove('show');
                                borrarRuta();
                                // Eliminar los marcadores de waypoints si existen
                                if (waypointMarkers && waypointMarkers.length) {
                                    waypointMarkers.forEach(m => mainMap.removeLayer(m));
                                    waypointMarkers = [];
                                }
                                detailSidebar.innerHTML = '';
                            };
                        });
                    }
                });
            }

            function renderAgenda() {
                const list = document.getElementById('agenda-list');
                list.innerHTML = agendaItems.length ? '' : '<p>No tienes actividades en tu agenda.</p>';
                agendaItems
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'list-group-item';
                        itemEl.innerHTML = `
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${item.title}</h6>
                                <small>${new Date(item.date).toLocaleDateString()}</small>
                            </div>
                            <p class="mb-1">${item.desc}</p>
                            <div id="steps-${item.id}" class="mt-2"></div>
                            <button class="btn btn-sm btn-outline-primary btn-suggest" data-item-id="${item.id}">Sugerir Pasos ‚ú®</button>
                            <button class="btn btn-sm btn-outline-danger float-end btn-delete-agenda" data-item-id="${item.id}">Eliminar</button>
                        `;
                        list.appendChild(itemEl);
                    });
            }

            function renderSavedEvents() {
                const container = document.getElementById('saved-events-list');
                container.innerHTML = '';
                const savedPosts = allPosts.filter(post => savedEvents.includes(post.id));
                if (savedPosts.length === 0) {
                    container.innerHTML = '<p class="p-3">No tienes eventos guardados.</p>';
                } else {
                    savedPosts.forEach(post => container.appendChild(renderSavedPost(post)));
                }
                savedEventsModal.show();
            }

            function savePost() {
                const text = document.getElementById('post-text').value.trim();
                if (!text || selectedMarkers.length === 0) {
                    alert("El texto de la publicaci√≥n y la ubicaci√≥n son obligatorios.");
                    return;
                }

                const termsOption = document.querySelector('input[name="terms-option"]:checked').value;
                const customText = document.getElementById('custom-terms-textarea').value.trim();

                if (termsOption === 'custom' && !customText) {
                    alert("Si eliges usar t√©rminos personalizados, el campo no puede estar vac√≠o.");
                    return;
                }

                const postTerms = {
                    type: termsOption,
                    text: termsOption === 'custom' ? customText : ''
                };

                const latlngs = selectedMarkers.map(m => m.getLatLng());
                const rutaInputs = document.querySelectorAll('#ruta-inputs input');
                const newPost = {
                    id: 'post_' + Date.now(),
                    author: USER_ID,
                    verified: currentUser.verified || false,
                    text: text,
                    privacidad: document.getElementById('post-privacy').value,
                    mediaURL: '',
                    type: document.getElementById('post-type').value,
                    eventDate: document.getElementById('post-date').value,
                    status: 'vigente',
                    likes: 0,
                    likers: [],
                    comentarios: [],
                    rutas: latlngs.map((latlng, i) => ({
                        coords: `${latlng.lat},${latlng.lng}`,
                        label: (rutaInputs[i] && rutaInputs[i].value.trim()) || `Punto ${i + 1}`
                    })),
                    terms: postTerms
                };

                const file = document.getElementById('file-media').files[0];
                const updateAndRefresh = (post) => {
                    allPosts.unshift(post);
                    localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(allPosts));
                    document.getElementById('create-post-form').reset();
                    document.getElementById('location-display').textContent = 'No se ha seleccionado ninguna ubicaci√≥n.';
                    document.getElementById('custom-terms-textarea').style.display = 'none';
                    selectedMarkers = [];
                    createPostModal.hide();
                    refreshUI();
                };

                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        newPost.mediaURL = e.target.result;
                        updateAndRefresh(newPost);
                    };
                    reader.readAsDataURL(file);
                } else {
                    updateAndRefresh(newPost);
                }
            }
            // --- MODALS FOR INSCRITOS & ASISTENCIA ---
            // Agregar modales solo si no existen ya en el DOM
            if (!document.getElementById('modal-inscritos')) {
                const modalInscritos = document.createElement('div');
                modalInscritos.innerHTML = `
                <div class="modal fade" id="modal-inscritos" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Inscritos al Evento</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <ul id="lista-inscritos" class="list-group"></ul>
                      </div>
                    </div>
                  </div>
                </div>`;
                document.body.appendChild(modalInscritos);
            }
            if (!document.getElementById('modal-asistencia')) {
                const modalAsistencia = document.createElement('div');
                modalAsistencia.innerHTML = `
                <div class="modal fade" id="modal-asistencia" tabindex="-1">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Verificaci√≥n de Asistencia</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div style="max-height:400px;overflow-y:auto;">
                          <table class="table table-bordered table-striped">
                            <thead><tr><th>ID de Usuario</th><th>Nombre</th><th>Estado de Asistencia</th></tr></thead>
                            <tbody id="tabla-asistencia"></tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>`;
                document.body.appendChild(modalAsistencia);
            }

            // --- EVENT LISTENERS SETUP ---
            function setupEventListeners() {
                document.getElementById('view-toggle-btn').addEventListener('click', toggleView);
                document.getElementById('publish-button').addEventListener('click', savePost);
                document.getElementById('map-filter-type').addEventListener('change', (e) => renderMapMarkers(e.target.value));
                document.querySelector('.create-post-widget-input').addEventListener('click', () => createPostModal.show());
                // Bot√≥n flotante para crear publicaci√≥n
                const floatingBtn = document.getElementById('floating-create-post-btn');
                if (floatingBtn) {
                    floatingBtn.addEventListener('click', () => createPostModal.show());
                }
                // Bot√≥n cl√°sico (por si existe en el feed cl√°sico)
                const classicBtn = document.querySelector('.new-post-button');
                if (classicBtn) {
                    classicBtn.addEventListener('click', () => createPostModal.show());
                }
                document.getElementById('menu-agenda').addEventListener('click', () => {
                    renderAgenda();
                    agendaModal.show();
                });
                document.getElementById('menu-inscripciones').addEventListener('click', () => {
                    window.location.href = 'mis_inscripciones.html';
                });
                document.getElementById('menu-guardados').addEventListener('click', renderSavedEvents);

                // Event listeners para filtros del sidebar
                document.querySelectorAll('.left-sidebar-down li').forEach(item => {
                    item.addEventListener('click', () => {
                        const filterType = item.dataset.filter || item.textContent.trim();
                        const mappedFilter = {
                            'Todos los tipos': 'all',
                            'Deporte': 'Deporte',
                            'Estudio': 'Estudio',
                            'Social': 'Social',
                            'Cultural': 'Cultural',
                            'Otro': 'Otro'
                        }[filterType] || 'all';

                        // Update select dropdown
                        document.getElementById('map-filter-type').value = mappedFilter;
                        renderMapMarkers(mappedFilter);

                        // Visual feedback
                        document.querySelectorAll('.left-sidebar-down li').forEach(li => li.style.backgroundColor = '');
                        item.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    });
                });

                const themeSelectorIcon = document.getElementById('theme-selector-icon');
                const themeSelectorDropdown = document.getElementById('theme-selector-dropdown');

                themeSelectorIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isShown = themeSelectorDropdown.classList.contains('show');
                    closeAllDropdowns();
                    if (!isShown) themeSelectorDropdown.classList.add('show');
                });

                // Theme selection
                document.querySelectorAll('.theme-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const themeName = item.dataset.theme;
                        applyTheme(themeName);
                        themeSelectorDropdown.classList.remove('show');
                    });
                });

                // Map styles dropdown functionality
                const mapStylesIcon = document.getElementById('map-styles-icon');
                const mapStylesDropdown = document.getElementById('map-styles-dropdown');

                mapStylesIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isShown = mapStylesDropdown.classList.contains('show');
                    closeAllDropdowns();
                    if (!isShown) mapStylesDropdown.classList.add('show');
                });

                // Map style selection
                document.querySelectorAll('.map-style-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const styleName = item.dataset.style;
                        changeMapStyle(styleName);
                        mapStylesDropdown.classList.remove('show');
                    });
                });


                const dropdownIcons = {
                    'requests-icon': 'requests-dropdown',
                    'notifications-icon': 'notifications-dropdown',
                    'profile-icon': 'profile-dropdown'
                };
                const closeAllDropdowns = () => {
                    document.getElementById('theme-selector-dropdown').classList.remove('show');
                    document.getElementById('map-styles-dropdown').classList.remove('show');
                    Object.values(dropdownIcons).forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.remove('show');
                    });
                };
                Object.keys(dropdownIcons).forEach(iconId => {
                    const icon = document.getElementById(iconId);
                    const dropdown = document.getElementById(dropdownIcons[iconId]);
                    if (icon && dropdown) {
                        icon.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const isShown = dropdown.classList.contains('show');
                            closeAllDropdowns();
                            if (!isShown) dropdown.classList.add('show');
                        });
                    }
                });
                window.addEventListener('click', closeAllDropdowns);

                document.getElementById('classic-feed-content').addEventListener('click', (e) => {
                    const button = e.target.closest('button, .save-star-icon');
                    if (!button) return;
                    const postId = button.dataset.postId;
                    if (!postId) return;
                    if (button.classList.contains('btn-like')) toggleLike(postId);
                    if (button.classList.contains('btn-delete'))
                        if (confirm('¬øEst√°s seguro de que quieres eliminar esta publicaci√≥n?')) eliminarPost(postId);
                    if (button.classList.contains('btn-comment')) {
                        const commentInput = button.previousElementSibling;
                        addComment(postId, commentInput.value);
                        commentInput.value = '';
                    }
                    if (button.classList.contains('btn-inscribirse')) {
                        handleSubscription(postId);
                    }
                    if (button.classList.contains('btn-ver-inscritos')) {
                        const post = allPosts.find(p => p.id === postId);
                        const lista = document.getElementById('lista-inscritos');
                        lista.innerHTML = post.inscritos.length ? post.inscritos.map(u => `<li class='list-group-item'><strong>${u.userId}</strong> - ${u.nombre}</li>`).join('') : '<li class="list-group-item">No hay inscritos.</li>';
                        new bootstrap.Modal(document.getElementById('modal-inscritos')).show();
                    }
                    if (button.classList.contains('btn-verificar-asistentes')) {
                        // Simulaci√≥n de datos de asistencia
                        const simulados = [
                            { userId: 'USER001', nombre: 'Ana Garc√≠a', asistio: true },
                            { userId: 'USER002', nombre: 'Luis P√©rez', asistio: true },
                            { userId: 'USER003', nombre: 'Mar√≠a L√≥pez', asistio: false },
                            { userId: 'USER004', nombre: 'Juan Rodr√≠guez', asistio: true },
                            { userId: 'USER005', nombre: 'Sof√≠a Mart√≠nez', asistio: false },
                            { userId: 'USER006', nombre: 'Carlos D√≠az', asistio: true },
                            { userId: 'USER007', nombre: 'Laura S√°nchez', asistio: false },
                            { userId: 'USER008', nombre: 'Pedro G√≥mez', asistio: true },
                            { userId: 'USER009', nombre: 'Elena Fern√°ndez', asistio: false },
                            { userId: 'USER010', nombre: 'Diego Ruiz', asistio: true }
                        ];
                        const tabla = document.getElementById('tabla-asistencia');
                        tabla.innerHTML = simulados.map(u => `<tr><td>${u.userId}</td><td>${u.nombre}</td><td>${u.asistio ? 'Asisti√≥ ‚úÖ' : 'No asisti√≥ ‚ùå'}</td></tr>`).join('');
                        new bootstrap.Modal(document.getElementById('modal-asistencia')).show();
                    }
                    if (button.classList.contains('btn-terms')) {
                        const post = allPosts.find(p => p.id === postId);
                        if (post && post.terms) {
                            let termsContent = '';
                            const defaultTermsText =
                                `T√âRMINOS Y CONDICIONES PREDETERMINADOS DE GEOPLANNER\n\n` +
                                `1. Aceptaci√≥n de los T√©rminos:\nAl crear y publicar un evento en GeoPlanner, usted (en adelante, "el Organizador") acepta y se compromete a cumplir en su totalidad los siguientes t√©rminos y condiciones.\n\n` +
                                `2. Responsabilidad Exclusiva del Organizador:\nEl Organizador es el √∫nico y exclusivo responsable de todos los aspectos del evento, incluyendo pero no limit√°ndose a:\n- Legalidad y Permisos: Asegurar que el evento cumple con todas las leyes y obtener todos los permisos necesarios.\n- Seguridad: Garantizar la seguridad de todos los asistentes y del lugar.\n- Contenido y Actividades: El contenido y las actividades durante el evento son su responsabilidad.\n\n` +
                                `3. Deslinde de Responsabilidad de GeoPlanner:\nGeoPlanner es una plataforma tecnol√≥gica que facilita la conexi√≥n y NO organiza, supervisa, ni controla los eventos. Por lo tanto, GeoPlanner se exime de toda responsabilidad por cualquier da√±o, p√©rdida, lesi√≥n o consecuencia legal que surja del evento.\n\n` +
                                `4. Prohibiciones Estrictas:\nEst√° terminantemente prohibido organizar eventos que involucren o fomenten:\n- Actividades Ilegales.\n- Armas y Explosivos.\n- Sustancias Il√≠citas.\n- Violencia, Discursos de Odio o Discriminaci√≥n.\n\n` +
                                `5. Verificaci√≥n de Identidad y Cooperaci√≥n con la Ley:\nUsted reconoce que su identidad fue verificada. En caso de reportarse una actividad il√≠cita, GeoPlanner cooperar√° con las autoridades y podr√° proporcionarles su informaci√≥n.\n\n` +
                                `Al publicar un evento, usted declara haber le√≠do, comprendido y aceptado estos t√©rminos en su totalidad.`;

                            if (post.terms.type === 'default') {
                                termsContent = defaultTermsText;
                            } else if (post.terms.type === 'custom') {
                                termsContent = `T√âRMINOS PERSONALIZADOS (BAJO RESPONSABILIDAD DEL ORGANIZADOR):\n\n${post.terms.text}`;
                            } else {
                                const predefined = post.terms.predefined && post.terms.predefined.length > 0 ? `T√©rminos predefinidos:\n- ${post.terms.predefined.join('\n- ')}` : '';
                                const custom = post.terms.custom ? `T√©rminos personalizados:\n${post.terms.custom}` : '';
                                termsContent = [predefined, custom].filter(Boolean).join('\n\n');
                            }

                            alert(termsContent || 'No hay t√©rminos especificados para este evento.');
                        }
                    }
                    if (button.classList.contains('save-star-icon')) toggleSaveEvent(postId);
                });

                document.getElementById('agenda-modal').addEventListener('click', async (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const itemId = button.dataset.itemId;
                    if (button.classList.contains('btn-delete-agenda')) {
                        agendaItems = agendaItems.filter(i => i.id !== itemId);
                        localStorage.setItem(STORAGE_KEY_AGENDA + USER_ID, JSON.stringify(agendaItems));
                        renderAgenda();
                    }
                    if (button.classList.contains('btn-suggest')) {
                        const item = agendaItems.find(i => i.id === itemId);
                        if (!item) return;
                        const prompt = `Para la actividad "${item.title}" programada para el ${item.date}, genera una lista de 5 a 7 pasos o tareas clave para su organizaci√≥n. Responde solo con los pasos, separados por comas.`;
                        const result = await callGeminiAPI(prompt, button);
                        if (result) {
                            const stepsHtml = result.split(',').map(step => `<li class="list-group-item list-group-item-light py-1">${step.trim()}</li>`).join('');
                            document.getElementById(`steps-${itemId}`).innerHTML = `<ul class="list-group mt-2">${stepsHtml}</ul>`;
                        }
                    }
                });
                document.getElementById('agenda-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newItem = {
                        id: 'agenda_' + Date.now(),
                        title: document.getElementById('agenda-title').value,
                        desc: document.getElementById('agenda-desc').value,
                        date: document.getElementById('agenda-date').value,
                    };
                    agendaItems.unshift(newItem);
                    localStorage.setItem(STORAGE_KEY_AGENDA + USER_ID, JSON.stringify(agendaItems));
                    renderAgenda();
                    e.target.reset();
                });

                const mapSelectModalEl = document.getElementById('map-select-modal');
                // Refuerza la apertura del modal de selecci√≥n de mapa como secundario
                const openMapSelectModal = () => {
                    // Oculta el modal principal visualmente, pero no lo cierra
                    const createPostModalEl = document.getElementById('create-post-modal');
                    if (createPostModalEl) {
                        createPostModalEl.classList.add('modal-blur');
                    }
                    const modalInstance = bootstrap.Modal.getOrCreateInstance(mapSelectModalEl, { backdrop: 'static', keyboard: false });
                    modalInstance.show();
                };
                // Reemplaza el evento de apertura del modal de selecci√≥n de mapa en el bot√≥n correspondiente
                const selectLocationBtn = document.getElementById('select-location-btn');
                if (selectLocationBtn) {
                    // Elimina cualquier atributo data-bs-toggle del bot√≥n
                    selectLocationBtn.removeAttribute('data-bs-toggle');
                    selectLocationBtn.removeAttribute('data-bs-target');
                    selectLocationBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        // Abre el modal secundario sin cerrar el principal
                        const modalInstance = bootstrap.Modal.getOrCreateInstance(mapSelectModalEl);
                        modalInstance.show();
                    });
                }
                mapSelectModalEl.addEventListener('shown.bs.modal', function () {
                    if (!selectionMap) {
                        selectionMap = L.map('modal-map-container').setView([10.654, -71.612], 13);
                        // Use current map style for selection map
                        const style = mapStyles[currentMapStyle];
                        L.tileLayer(style.url, {
                            attribution: style.attribution
                        }).addTo(selectionMap);
                        // Routing control for the selection modal
                        let selectionRoutingControl = null;
                        selectionMap.on('click', (e) => {
                            if (routeType === 'simple' && selectedMarkers.length > 0) clearSelectionMap();
                            const newMarker = L.marker(e.latlng).addTo(selectionMap);
                            selectedMarkers.push(newMarker);
                            // Remove previous routing control if exists
                            if (selectionRoutingControl) {
                                selectionMap.removeControl(selectionRoutingControl);
                                selectionRoutingControl = null;
                            }
                            if (routeType === 'multiple' && selectedMarkers.length > 1) {
                                // Remove polyline if exists (legacy)
                                if (selectionPolyline) {
                                    selectionMap.removeLayer(selectionPolyline);
                                    selectionPolyline = null;
                                }
                                // Prepare waypoints
                                const waypoints = selectedMarkers.map(m => m.getLatLng());
                                selectionRoutingControl = L.Routing.control({
                                    waypoints: waypoints,
                                    createMarker: function() { return null; },
                                    routeWhileDragging: false,
                                    show: false,
                                    addWaypoints: false,
                                    lineOptions: {
                                        styles: [{color: '#007BFF', opacity: 0.8, weight: 5}]
                                    }
                                }).addTo(selectionMap);
                            } else if (routeType === 'multiple' && selectedMarkers.length === 1) {
                                // Remove routing control if only one marker
                                if (selectionRoutingControl) {
                                    selectionMap.removeControl(selectionRoutingControl);
                                    selectionRoutingControl = null;
                                }
                            }
                        });
                    }
                    setTimeout(() => selectionMap.invalidateSize(), 10);
                });
                mapSelectModalEl.addEventListener('hidden.bs.modal', function () {
                    // Al cerrar el modal de selecci√≥n de ubicaci√≥n, vuelve a mostrar el principal
                    const createPostModalEl = document.getElementById('create-post-modal');
                    if (createPostModalEl) {
                        createPostModalEl.classList.remove('modal-blur');
                    }
                });
                const clearSelectionMap = () => {
                    selectedMarkers.forEach(m => selectionMap.removeLayer(m));
                    selectedMarkers = [];
                    if (selectionPolyline) {
                        selectionMap.removeLayer(selectionPolyline);
                        selectionPolyline = null;
                    }
                    // Remove routing control if exists
                    if (typeof selectionRoutingControl !== 'undefined' && selectionRoutingControl) {
                        selectionMap.removeControl(selectionRoutingControl);
                        selectionRoutingControl = null;
                    }
                };
                document.getElementById('clear-map-button').addEventListener('click', clearSelectionMap);
                document.getElementById('simple-route-tab').addEventListener('click', () => {
                    routeType = 'simple';
                    clearSelectionMap();
                });
                document.getElementById('multiple-route-tab').addEventListener('click', () => {
                    routeType = 'multiple';
                    clearSelectionMap();
                });
                document.getElementById('accept-location-button').addEventListener('click', () => {
                    if (selectedMarkers.length > 0) {
                        const latlngs = selectedMarkers.map(m => m.getLatLng());
                        document.getElementById('location-display').textContent = routeType === 'simple' ? `Ubicaci√≥n: [${latlngs[0].lat.toFixed(4)}, ${latlngs[0].lng.toFixed(4)}]` : `Ruta M√∫ltiple (${selectedMarkers.length} puntos)`;
                        // Quita el foco del bot√≥n para evitar el warning de accesibilidad
                        document.activeElement.blur();
                        // Cierra el modal de selecci√≥n de ubicaci√≥n
                        bootstrap.Modal.getInstance(mapSelectModalEl).hide();
                        // Remueve el blur del modal principal y lo muestra expl√≠citamente
                        const createPostModalEl = document.getElementById('create-post-modal');
                        if (createPostModalEl) {
                            createPostModalEl.classList.remove('modal-blur');
                            bootstrap.Modal.getOrCreateInstance(createPostModalEl).show();
                        }
                    } else {
                        alert("Por favor, selecciona al menos un punto.");
                    }
                });

                const termsDefaultRadio = document.getElementById('terms-default-radio');
                const termsCustomRadio = document.getElementById('terms-custom-radio');
                const customTermsTextarea = document.getElementById('custom-terms-textarea');

                termsDefaultRadio.addEventListener('change', () => {
                    if (termsDefaultRadio.checked) {
                        customTermsTextarea.style.display = 'none';
                    }
                });

                termsCustomRadio.addEventListener('change', () => {
                    if (termsCustomRadio.checked) {
                        customTermsTextarea.style.display = 'block';
                    }
                });
            }

            async function callGeminiAPI(prompt, button) {
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Respuesta no v√°lida de la API.");
                    }
                } catch (error) {
                    console.error("Error con API de Gemini:", error);
                    alert("Hubo un error al contactar a la IA.");
                    return null;
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            // --- BUSCADOR DE DIRECCIONES ---
            let searchMarker = null;

            const addressInput = document.getElementById('address-search-input');
            const addressBtn = document.getElementById('address-search-btn');
            const suggestionsBox = document.getElementById('address-suggestions');

            // Funci√≥n para buscar sugerencias en Nominatim
            addressInput.addEventListener('input', async function () {
                const query = this.value.trim();
                if (query.length < 3) {
                    suggestionsBox.innerHTML = '';
                    suggestionsBox.style.display = 'none';
                    return;
                }
                // Limitar b√∫squeda a Venezuela
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5&countrycodes=ve`;
                try {
                    const res = await fetch(url, { headers: { 'Accept-Language': 'es' } });
                    const results = await res.json();
                    if (results.length === 0) {
                        suggestionsBox.innerHTML = '<div class="list-group-item">No se encontraron resultados.          </div>';
                        suggestionsBox.style.display = 'block';
                        return;
                    }
                    suggestionsBox.innerHTML = results.map(r =>
                        `<button type="button" class="list-group-item list-group-item-action" data-lat="${r.lat}" data-lon="${r.lon}">${r.display_name}</button>`
                    ).join('');
                    suggestionsBox.style.display = 'block';
                } catch (err) {
                    suggestionsBox.innerHTML = '<div class="list-group-item">Error de conexi√≥n.</div>';
                    suggestionsBox.style.display = 'block';
                }
            });

            // Al hacer clic en una sugerencia
            suggestionsBox.addEventListener('click', function (e) {
                const btn = e.target.closest('button[data-lat][data-lon]');
                if (!btn) return;
                const lat = parseFloat(btn.dataset.lat);
                const lon = parseFloat(btn.dataset.lon);
                centerMapOnAddress(lat, lon, btn.textContent);
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
                addressInput.value = btn.textContent;
            });

            // Al hacer clic en el bot√≥n de buscar
            addressBtn.addEventListener('click', async function () {
                const query = addressInput.value.trim();
                if (!query) return;
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=1&countrycodes=ve`;
                try {
                    const res = await fetch(url, { headers: { 'Accept-Language': 'es' } });
                    const results = await res.json();
                    if (results.length > 0) {
                        const lat = parseFloat(results[0].lat);
                        const lon = parseFloat(results[0].lon);
                        centerMapOnAddress(lat, lon, results[0].display_name);
                    } else {
                        alert('No se encontr√≥ la direcci√≥n.');
                    }
                } catch (err) {
                    alert('Error de conexi√≥n.');
                }
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';
            });

            // Centrar el mapa y mostrar marcador
            function centerMapOnAddress(lat, lon, label) {
                if (!mainMap) return;
                mainMap.setView([lat, lon], 16, { animate: true });
                if (searchMarker) mainMap.removeLayer(searchMarker);
                searchMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        html: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24           24"><path fill="#007bff" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.       87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12        2.5-2.5 2.5z"/></svg>`,
                        className: 'search-marker',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -36]
                    })
                }).addTo(mainMap).bindPopup(`<b>${label}</b>`).openPopup();
            }

            // Cerrar sugerencias al hacer clic fuera
            document.addEventListener('click', function (e) {
                if (!addressInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                    suggestionsBox.innerHTML = '';
                    suggestionsBox.style.display = 'none';
                }
            });

            // --- BUSCADOR DE DIRECCIONES EN EL MODAL DE UBICACI√ìN ---
            let modalSearchMarker = null;

            const modalAddressInput = document.getElementById('modal-address-search-input');
            const modalAddressBtn = document.getElementById('modal-address-search-btn');
            const modalSuggestionsBox = document.getElementById('modal-address-suggestions');

            // Buscar sugerencias en Nominatim para el modal
            modalAddressInput.addEventListener('input', async function () {
                const query = this.value.trim();
                if (query.length < 3) {
                    modalSuggestionsBox.innerHTML = '';
                    modalSuggestionsBox.style.display = 'none';
                    return;
                }
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5&countrycodes=ve`;
                try {
                    const res = await fetch(url, { headers: { 'Accept-Language': 'es' } });
                    const results = await res.json();
                    if (results.length === 0) {
                        modalSuggestionsBox.innerHTML = '<div class="list-group-item">No se encontraron             resultados.</div>';
                        modalSuggestionsBox.style.display = 'block';
                        return;
                    }
                    modalSuggestionsBox.innerHTML = results.map(r =>
                        `<button type="button" class="list-group-item list-group-item-action" data-lat="${r.lat}" data-lon="${r.lon}">${r.display_name}</button>`
                    ).join('');
                    modalSuggestionsBox.style.display = 'block';
                } catch (err) {
                    modalSuggestionsBox.innerHTML = '<div class="list-group-item">Error de conexi√≥n.</div>';
                    modalSuggestionsBox.style.display = 'block';
                }
            });

            // Al hacer clic en una sugerencia del modal
            modalSuggestionsBox.addEventListener('click', function (e) {
                const btn = e.target.closest('button[data-lat][data-lon]');
                if (!btn) return;
                const lat = parseFloat(btn.dataset.lat);
                const lon = parseFloat(btn.dataset.lon);
                centerModalMapOnAddress(lat, lon, btn.textContent);
                modalSuggestionsBox.innerHTML = '';
                modalSuggestionsBox.style.display = 'none';
                modalAddressInput.value = btn.textContent;
            });

            // Al hacer clic en el bot√≥n de buscar del modal
            modalAddressBtn.addEventListener('click', async function () {
                const query = modalAddressInput.value.trim();
                if (!query) return;
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=1&countrycodes=ve`;
                try {
                    const res = await fetch(url, { headers: { 'Accept-Language': 'es' } });
                    const results = await res.json();
                    if (results.length > 0) {
                        const lat = parseFloat(results[0].lat);
                        const lon = parseFloat(results[0].lon);
                        centerModalMapOnAddress(lat, lon, results[0].display_name);
                    } else {
                        alert('No se encontr√≥ la direcci√≥n.');
                    }
                } catch (err) {
                    alert('Error de conexi√≥n.');
                }
                modalSuggestionsBox.innerHTML = '';
                modalSuggestionsBox.style.display = 'none';
            });

            // Centrar el mapa del modal y mostrar marcador
            function centerModalMapOnAddress(lat, lon, label) {
                if (!selectionMap) return;
                selectionMap.setView([lat, lon], 16, { animate: true });
                // Elimina marcador anterior de b√∫squeda
                if (modalSearchMarker) selectionMap.removeLayer(modalSearchMarker);
                // Elimina marcadores de selecci√≥n previos si es ruta simple
                if (routeType === 'simple' && selectedMarkers.length > 0) {
                    selectedMarkers.forEach(m => selectionMap.removeLayer(m));
                    selectedMarkers = [];
                }
                // A√±ade marcador de b√∫squeda y lo selecciona como punto de la publicaci√≥n
                modalSearchMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        html: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24           24"><path fill="#007bff" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.       87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12        2.5-2.5 2.5z"/></svg>`,
                        className: 'search-marker',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -36]
                    })
                }).addTo(selectionMap).bindPopup(`<b>${label}</b>`).openPopup();

                // Para ruta simple, selecciona autom√°ticamente este punto
                if (routeType === 'simple') {
                    selectedMarkers.push(modalSearchMarker);
                }
            }

            // Cerrar sugerencias al hacer clic fuera del buscador del modal
            document.addEventListener('click', function (e) {
                if (!modalAddressInput.contains(e.target) && !modalSuggestionsBox.contains(e.target)) {
                    modalSuggestionsBox.innerHTML = '';
                    modalSuggestionsBox.style.display = 'none';
                }
            });

            // --- INITIALIZATION ---
            function initialize() {
                initData();
                initMainMap();
                renderMapMarkers();
                setupEventListeners();
                renderClassicFeed();
            }

            initialize();
        });
    </script>
</body>

</html>