<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoPlanner - Red Social</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root {
      --header-bg: linear-gradient(145deg, #007BFF, #003366);
      --header-text-color: white;
      --header-icon-bg: rgba(255, 255, 255, 0.15);
      --header-icon-hover-bg: rgba(255, 255, 255, 0.25);
      
      --body-bg: #f0f2f5;
      
      --sidebar-bg: linear-gradient(145deg, #007BFF, #003366);
      --sidebar-text-color: white;
      --sidebar-hover-bg: rgba(255, 255, 255, 0.15);

      --card-bg: #ffffff;
      --card-text-color: #333;
      --card-secondary-text-color: #6c757d;

      --btn-primary-bg: #0d6efd;
      --btn-primary-text: white;
      --btn-secondary-bg: #6c757d;
      --btn-secondary-text: white;
    }
    body {
      background-color: var(--body-bg); /* MODIFICADO */
      color: var(--card-text-color); /* MODIFICADO */
      font-family: 'Segoe UI', sans-serif;
    }

    header {
      background: var(--header-bg); /* MODIFICADO */
      color: var(--header-text-color); /* MODIFICADO */
      padding: 0.75rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1030;
    }


    .search-bar input {
      width: 300px;
      border-radius: 20px;
      padding: 0.4rem 1rem;
      border: none;
    }

    .icon-bar {
      position: relative;
      display: flex;
      gap: 0.5rem;
    }

    .icon-button {
      background-color: var(--header-icon-bg); /* MODIFICADO */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .icon-button:hover {
        background-color: var(--header-icon-hover-bg); /* MODIFICADO */
    }
    
    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      top: 55px;
      background-color: var(--card-bg); /* MODIFICADO */
      color: var(--card-text-color); /* MODIFICADO */
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 10px;
      width: 360px;
      z-index: 2000;
      border: 1px solid #ddd;
    }
    
    .dropdown-content.show {
        display: block;
    }
    
    .dropdown-header {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 1rem;
    }

    .dropdown-item-custom {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.5rem;
        border-radius: 8px;
        transition: background-color 0.2s;
        color: var(--card-text-color); /* MODIFICADO */
    }
    .dropdown-item-custom:hover {
        background-color: var(--body-bg); /* MODIFICADO */
        text-decoration: none;
        color: inherit;
    }
    .dropdown-item-custom img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
    }

    .notification-buttons button.btn-primary {
        background-color: var(--btn-primary-bg) !important; /* MODIFICADO */
        color: var(--btn-primary-text) !important; /* MODIFICADO */
    }
    .notification-buttons button.btn-secondary {
        background-color: var(--btn-secondary-bg) !important; /* MODIFICADO */
        color: var(--btn-secondary-text) !important; /* MODIFICADO */
    }


    .main-container {
      display: flex;
      justify-content: center;
      padding: 1.5rem;
      gap: 2rem;
    }

    .left-sidebar {
      width: 250px;
      background: var(--sidebar-bg); /* MODIFICADO */
      color: var(--sidebar-text-color); /* MODIFICADO */
      padding: 1.5rem;
      border-radius: 10px;
      height: fit-content;
      position: sticky;
      top: 90px;
    }

    .left-sidebar ul {
      list-style: none;
      padding-left: 0;
    }

    .left-sidebar li {
      margin-bottom: 1rem;
      font-weight: 500;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 8px;
      transition: background-color 0.2s;
    }

    .left-sidebar li:hover {
      background-color: var(--sidebar-hover-bg); /* MODIFICADO */
    }
    
    .feed {
      flex: 1;
      max-width: 680px;
    }
    
    .right-sidebar {
        width: 300px;
        background-color: var(--card-bg); /* MODIFICADO */
        color: var(--card-text-color); /* MODIFICADO */
        padding: 1rem;
        border-radius: 10px;
        height: fit-content;
        position: sticky;
        top: 90px;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.05);
    }
    .right-sidebar small {
        color: var(--card-secondary-text-color) !important; /* MODIFICADO */
    }

    .post, .new-post {
      background-color: var(--card-bg); /* MODIFICADO */
      color: var(--card-text-color); /* MODIFICADO */
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.05);
    }

    .post img, .new-post img {
      max-width: 100%;
      border-radius: 10px;
      margin-bottom: 0.5rem;
    }
    #publish-button, .modal-footer .btn-primary {
        background-color: var(--btn-primary-bg);
        color: var(--btn-primary-text);
        border: none;
    }
    .map-container {
      height: 250px;
      border-radius: 10px;
      margin-top: 0.5rem;
    }
    
    #location-display {
        border: 1px dashed #ccc;
        padding: 0.5rem;
        border-radius: 8px;
        min-height: 40px;
        background-color: var(--body-bg); /* MODIFICADO */
        color: var(--card-secondary-text-color); /* MODIFICADO */
    }
    #post-map-preview-container {
        height: 0;
        transition: height 0.3s ease;
        border-radius: 10px;
        margin-top: 0.5rem;
        overflow: hidden;
    }
    #map-modal .modal-dialog {
        max-width: 800px;
    }
    #modal-map-container {
        height: 50vh;
        border-radius: 10px;
    }
  </style>
</head>
<body>

  <header>
    <div class="d-flex align-items-center gap-2">
        <a href="dashboard.html" class="d-flex align-items-center gap-2 text-white text-decoration-none">
        <img src="img/LogoMini.png" alt="Logo" style="width: 36px;" />
        <strong class="fs-5">GeoPlanner</strong>
      </a>
    </div>
    <div class="search-bar">
      <input type="text" placeholder="Buscar personas o grupos..." />
    </div>
    <div class="icon-bar">
      <span class="icon-button" id="requests-icon" title="Solicitudes de amistad">🤝</span>
      <div class="dropdown-content" id="requests-dropdown">
        <div class="dropdown-header">Solicitudes de amistad</div>
        <a href="#" class="dropdown-item-custom">
            <img src="img/placeholder.png" alt="user">
            <div>
                <strong>Ana Rodriguez</strong> quiere ser tu amiga.
                <div class="d-flex gap-2 mt-2 notification-buttons">
                    <button class="btn btn-primary btn-sm">Aceptar</button>
                    <button class="btn btn-secondary btn-sm">Rechazar</button>
                </div>
            </div>
        </a>
        <hr class="my-2">
        <a href="#" class="dropdown-item-custom">
            <img src="img/placeholder.png" alt="user">
            <div>
                <strong>Luis Perez</strong> te envió una solicitud.
                <div class="d-flex gap-2 mt-2 notification-buttons">
                    <button class="btn btn-primary btn-sm">Aceptar</button>
                    <button class="btn btn-secondary btn-sm">Rechazar</button>
                </div>
            </div>
        </a>
      </div>

      <span class="icon-button" id="notifications-icon" title="Notificaciones">🔔</span>
      <div class="dropdown-content" id="notifications-dropdown">
        <div class="dropdown-header">Notificaciones</div>
        <a href="#" class="dropdown-item-custom">
            <img src="img/estudio.jpg" alt="event">
            <div><strong>@carlos_martinez</strong> comentó en tu publicación: "¡Allí estaré!".</div>
        </a>
        <hr class="my-2">
        <a href="#" class="dropdown-item-custom">
            <img src="img/LogoMini.png" alt="system">
            <div>A <strong>3 personas</strong> más les gustó tu evento "Picnic con amigos".</div>
        </a>
         <hr class="my-2">
        <a href="#" class="dropdown-item-custom">
            <img src="img/placeholder.png" alt="group">
            <div>Se ha creado un nuevo evento en el grupo "Amantes del Senderismo".</div>
        </a>
      </div>

      <span class="icon-button" id="profile-icon" title="Perfil">👤</span>
      <div class="dropdown-content" id="profile-dropdown">
        <a href="perfil.html" class="dropdown-item-custom">
             <img class="foto-usuario" src="" alt="profile">
            <div>
                <span class="nombre-usuario"></span>
                <br>
                <small >Ver tu perfil</small>
            </div>
        </a>
        <hr class="my-2">
         <a href="#" class="dropdown-item-custom">
            <span>⚙️</span>
            <div><strong>Configuración</strong></div>
        </a>
         <a href="index.html" class="dropdown-item-custom" id="logout-button">
            <span>➡️</span>
            <div><strong>Cerrar sesión</strong></div>
        </a>
      </div>
    </div>
  </header>

  <div class="container-xl">
    <div class="main-container row">
      <aside class="left-sidebar col-lg-3 d-none d-lg-block">
        <ul>
          <li>🏠 Inicio</li>
          <li>🧑‍🤝‍🧑 Mis Amigos</li>
          <li>👨‍👩‍👧‍👦 Grupos</li>
          <li>📅 Mis Eventos</li>
        </ul>
      </aside>

      <div class="col-lg-6 col-md-12">
        
        <div class="new-post">
            <h6><strong>Crear nueva publicación</strong></h6>
            <textarea id="post-text" class="form-control mb-2" rows="2" placeholder="¿Qué estás organizando?..."></textarea>
            <label for="file-media" class="form-label">Subir fotos o videos (opcional)</label>
            <input type="file" id="file-media" class="form-control mb-2" accept="image/*,video/*" />
            
            <button class="btn btn-outline-primary w-100 mb-2" type="button" data-bs-toggle="modal" data-bs-target="#map-modal">
                📍 Seleccionar Ubicación (Obligatorio)
            </button>
            <div id="location-display" class="mb-2">No se ha seleccionado ninguna ubicación.</div>
            
            <div id="post-map-preview-container"></div>
            <select class="form-select mb-2" id="privacidad">
                <option value="publica">Pública</option>
                <option value="amigos">Solo amigos</option>
                <option value="privada">Privada con invitación</option>
            </select>
            
            <div class="mb-3">
              <label for="custom-terms" class="form-label">Términos y Condiciones Personalizados</label>
              <textarea id="custom-terms" class="form-control" rows="3" placeholder="Escribe términos personalizados aquí..."></textarea>
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="terms-weapons">
                <label class="form-check-label" for="terms-weapons">Prohibición de armas</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="terms-illegal-substances">
                <label class="form-check-label" for="terms-illegal-substances">Prohibición de sustancias ilegales</label>
              </div>
            </div>
            <button id="publish-button" class="btn btn-primary w-100" disabled>Publicar</button>
        </div>

        <main class="feed"></main>

      </div>

      <aside class="right-sidebar col-lg-3 d-none d-xl-block">
        <h6 class="fw-bold mb-3">Eventos Cercanos a Ti 🗺️</h6>
        
        <div class="d-flex flex-column gap-3">
            <div class="d-flex gap-2">
                <img src="img/estudio.jpg" alt="evento" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                <div>
                    <div class="fw-bold">Tarde de Cine</div>
                    <small class="text-muted">Cinex, a 2.5 km</small>
                    <a href="#" class="d-block">Ver más</a>
                </div>
            </div>
            <div class="d-flex gap-2">
                <img src="img/placeholder.png" alt="evento" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                <div>
                    <div class="fw-bold">Concierto Acústico</div>
                    <small class="text-muted">Plaza de la República, a 1.2 km</small>
                      <a href="#" class="d-block">Ver más</a>
                </div>
            </div>
            <div class="d-flex gap-2">
                <img src="img/LogoMini.png" alt="evento" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                <div>
                    <div class="fw-bold">Torneo de Ajedrez</div>
                    <small class="text-muted">Biblioteca Pública, a 800 m</small>
                      <a href="#" class="d-block">Ver más</a>
                </div>
            </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="modal fade" id="map-modal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mapModalLabel">Define la ubicación de tu evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <ul class="nav nav-tabs" id="route-type-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="simple-route-tab" data-bs-toggle="tab" data-bs-target="#map-panel" type="button" role="tab">📍 Ruta Simple</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="multiple-route-tab" data-bs-toggle="tab" data-bs-target="#map-panel" type="button" role="tab">➯ Ruta Múltiple</button>
                </li>
            </ul>
            
            <p class="form-text mt-2">
                <strong>Ruta Simple:</strong> Haz clic en el mapa para colocar un único marcador.<br>
                <strong>Ruta Múltiple:</strong> Haz clic en varios puntos para trazar una ruta.
            </p>
            <div id="modal-map-container" style="height: 400px;"></div>
            <div id="ruta-inputs" class="mt-3"></div> 

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning" id="clear-map-button">Limpiar Mapa</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="accept-location-button">Aceptar</button>
        </div>
      </div>
    </div>
  </div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const STORAGE_KEY = 'geoplanner_posts';
    const USER_ID = 'juan_sarcos'; 

    const dropdownIcons = {
        'requests-icon': 'requests-dropdown',
        'notifications-icon': 'notifications-dropdown',
        'profile-icon': 'profile-dropdown'
    };
    const closeAllDropdowns = () => {
        Object.values(dropdownIcons).forEach(dropdownId => {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) dropdown.classList.remove('show');
        });
    };
    Object.keys(dropdownIcons).forEach(iconId => {
        const icon = document.getElementById(iconId);
        const dropdown = document.getElementById(dropdownIcons[iconId]);
        if (icon && dropdown) {
            icon.addEventListener('click', function(event) {
                event.stopPropagation();
                const isCurrentlyShown = dropdown.classList.contains('show');
                closeAllDropdowns();
                if (!isCurrentlyShown) {
                    dropdown.classList.add('show');
                }
            });
        }
    });
    window.addEventListener('click', () => closeAllDropdowns());
    const logoutButton = document.getElementById('logout-button');
    if(logoutButton) {
        logoutButton.addEventListener('click', () => alert("Cerrando sesión..."));
    }

    const mapModalEl = document.getElementById('map-modal');
    const acceptLocationButton = document.getElementById('accept-location-button');
    const clearMapButton = document.getElementById('clear-map-button');
    const publishButton = document.getElementById('publish-button');
    const locationDisplay = document.getElementById('location-display');
    const postMapPreviewContainer = document.getElementById('post-map-preview-container');
    
    let modalMap, postPreviewMap;
    let routeType = 'simple';
    let markers = [];
    let polyline = null;
    
    const geoPlannerIcon = L.icon({
        iconUrl: 'img/LogoMini.png',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
    });

    mapModalEl.addEventListener('shown.bs.modal', function () {
        if (!modalMap) {
            modalMap = L.map('modal-map-container').setView([10.654, -71.612], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(modalMap);
            modalMap.on('click', onMapClick);
        }
        setTimeout(() => modalMap.invalidateSize(), 10);
    });

    document.getElementById('simple-route-tab').addEventListener('click', () => {
        routeType = 'simple';
        clearMap();
    });
    document.getElementById('multiple-route-tab').addEventListener('click', () => {
        routeType = 'multiple';
        clearMap();
    });
    
    const onMapClick = (e) => {
        if (routeType === 'simple' && markers.length > 0) clearMap();
        
        const newMarker = L.marker(e.latlng, { icon: geoPlannerIcon }).addTo(modalMap);
        markers.push(newMarker);
        
        if (routeType === 'multiple') {
             if (markers.length > 1) {
                if(polyline) modalMap.removeLayer(polyline);
                const latlngs = markers.map(m => m.getLatLng());
                polyline = L.polyline(latlngs, {color: '#007BFF'}).addTo(modalMap);
            }
            
            const rutaInputsContainer = document.getElementById('ruta-inputs');
            const index = markers.length;
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group input-group-sm mb-2';
            inputGroup.innerHTML = `
                <span class="input-group-text">${index}</span>
                <input type="text" placeholder="Descripción para el punto ${index}" class="form-control" data-index="${index - 1}">
            `;
            rutaInputsContainer.appendChild(inputGroup);
        }
    };
    
    const clearMap = () => {
        markers.forEach(m => modalMap.removeLayer(m));
        markers = [];
        if (polyline) {
            modalMap.removeLayer(polyline);
            polyline = null;
        }
        document.getElementById('ruta-inputs').innerHTML = '';
    };
    
    clearMapButton.addEventListener('click', clearMap);

    acceptLocationButton.addEventListener('click', function() {
        if (markers.length === 0) {
            alert("Por favor, selecciona al menos un punto en el mapa.");
            return;
        }

        const latlngs = markers.map(m => m.getLatLng());
        locationDisplay.textContent = routeType === 'simple'
            ? `Ubicación: [${latlngs[0].lat.toFixed(4)}, ${latlngs[0].lng.toFixed(4)}]`
            : `Ruta Múltiple (${markers.length} puntos)`;

        postMapPreviewContainer.style.height = '200px';
        if (!postPreviewMap) {
            postPreviewMap = L.map('post-map-preview-container', { zoomControl: false, scrollWheelZoom: false, dragging: false });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(postPreviewMap);
        } else {
            postPreviewMap.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) postPreviewMap.removeLayer(layer);
            });
        }
        
        latlngs.forEach(latlng => L.marker(latlng, { icon: geoPlannerIcon }).addTo(postPreviewMap));
        if (routeType === 'multiple' && latlngs.length > 1) {
            L.polyline(latlngs, {color: '#007BFF'}).addTo(postPreviewMap);
        }
        
        const bounds = L.latLngBounds(latlngs);
        postPreviewMap.fitBounds(bounds, { padding: [40, 40] });

        publishButton.disabled = false;
        bootstrap.Modal.getInstance(mapModalEl).hide();
    });

    function initExamplePosts() {
        if (localStorage.getItem(STORAGE_KEY)) return;
        const examples = [
             {
                id: 'post_carlos', autor: 'carlos_martinez', username: 'carlos_martinez', texto: 'Nos vemos en el parque central para una sesión de estudio.', privacidad: 'publica', mediaURL: 'img/estudio.jpg',
                ubicacion: '10.659,-71.611',
                rutas: [{ coords: '10.659,-71.611', label: 'Punto de encuentro' }],
                timestamp: new Date().toISOString(), likes: 2, likers: ['ana_g', 'luis_p'], comentarios: [{ autor: 'ana_g', texto: '¡Allí estaré!' }],
                terms: { custom: 'Ser puntuales.', predefined: ['Prohibición de armas'] }
            },
            {
                id: 'post_valentina', autor: 'valentina_g', username: 'valentina_g', texto: 'Picnic con amigos en el Jardín Botánico este domingo.', privacidad: 'amigos', mediaURL: '',
                ubicacion: '10.661,-71.618',
                rutas: [{ coords: '10.661,-71.618', label: 'Lugar del picnic' }],
                timestamp: new Date().toISOString(), likes: 1, likers: [USER_ID], comentarios: [{ autor: 'valentina_g', texto: 'Invitados confirmados 😊' }],
                terms: { custom: null, predefined: [] }
            }
        ];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(examples));
    }

    function loadPosts() {
        const posts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const feed = document.querySelector('.feed');
        
        feed.innerHTML = ''; 
        posts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        posts.forEach(post => feed.appendChild(renderPost(post)));
    }

    function renderPost(post) {
        const container = document.createElement('div');
        container.classList.add('post');
        const privacyBadge = {
            publica: '🔓 Pública',
            amigos: '👥 Amigos',
            privada: '🔒 Privada'
        }[post.privacidad] || '🔓 Pública';

        // Lógica de renderizado principal
        container.innerHTML = `
            <h6>
                <strong>${post.autor}</strong>
                <small style="color: gray; font-size: 0.85em;">@${post.username || post.autor}</small>
                <span class="badge bg-secondary">${privacyBadge}</span>
            </h6>
            <p>${post.texto}</p>
            ${post.mediaURL ? `<img src="${post.mediaURL}" alt="Media" class="img-fluid rounded mb-2">` : ''}
            <div class="map-container mb-2" id="map-${post.id}"></div>
            ${post.rutas.length > 1
                ? `<ol id="ruta-list-${post.id}" class="list-group list-group-flush list-group-numbered mb-2 small"></ol>`
                : (post.rutas.length === 1 && post.rutas[0].label)
                ? `<small class="d-block mb-2 text-muted">📍 ${post.rutas[0].label}</small>`
                : ''}
            <div class="d-flex gap-2 mt-2">
                <button class="btn btn-sm btn-outline-danger" id="btn-like-${post.id}">
                    ${post.likers.includes(USER_ID) ? '💔 Quitar Like' : '❤️ Like'} (<span id="likes-${post.id}">${post.likes}</span>)
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="btn-comment-toggle-${post.id}">💬 Comentarios (${post.comentarios.length})</button>
                <button class="btn btn-sm btn-outline-info" id="btn-terms-${post.id}">📜 Ver Términos</button>
            </div>
            <div class="comentarios mt-2 collapse" id="comentarios-${post.id}">
                <div class="comentarios-list mb-2">
                    ${post.comentarios.map(c => `<div class="small"><strong>@${c.autor}:</strong> ${c.texto}</div>`).join('')}
                </div>
                <div class="input-group mt-2">
                    <input type="text" class="form-control form-control-sm" id="input-${post.id}" placeholder="Escribe un comentario...">
                    <button class="btn btn-sm btn-primary" id="btn-comment-${post.id}">Enviar</button>
                </div>
            </div>
        `;

        // Lógica para el mapa
        const mapElement = container.querySelector(`#map-${post.id}`);
        setTimeout(() => {
             const map = L.map(mapElement, { zoomControl: false, scrollWheelZoom: false, dragging: true });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            const postMarkers = [];
            post.rutas.forEach(r => {
                const latlng = r.coords.split(',').map(Number);
                const marker = L.marker(latlng, { icon: L.icon({ iconUrl: 'img/LogoMini.png', iconSize: [32, 32], iconAnchor: [16, 32] }) })
                    .bindPopup(r.label)
                    .addTo(map);
                postMarkers.push(marker);
            });

            if (post.rutas.length > 1) {
                const polyline = L.polyline(post.rutas.map(r => r.coords.split(',').map(Number)), {color: '#007BFF'}).addTo(map);
                map.fitBounds(polyline.getBounds(), { padding: [30, 30] });
            } else if (postMarkers.length > 0) {
                map.setView(postMarkers[0].getLatLng(), 15);
            }
             map.invalidateSize();
        }, 0);
        
        // Lógica para la lista de rutas
        if (post.rutas.length > 1) {
            const list = container.querySelector(`#ruta-list-${post.id}`);
            post.rutas.forEach(r => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = r.label;
                list.appendChild(li);
            });
        }
        
        // Listeners para botones de acción
        container.querySelector(`#btn-like-${post.id}`).addEventListener('click', () => toggleLike(post.id));
        container.querySelector(`#btn-comment-toggle-${post.id}`).addEventListener('click', () => new bootstrap.Collapse(container.querySelector(`#comentarios-${post.id}`), { toggle: true }));
        container.querySelector(`#btn-comment-${post.id}`).addEventListener('click', () => {
            const input = container.querySelector(`#input-${post.id}`);
            if (input.value.trim()) {
                addComment(post.id, input.value.trim());
                input.value = '';
            }
        });

        // INICIO: LÓGICA INTEGRADA (Botón de Términos)
        container.querySelector(`#btn-terms-${post.id}`).addEventListener('click', () => {
            if (post.terms) {
                const predefined = post.terms.predefined && post.terms.predefined.length > 0 ? `Términos predefinidos:\n- ${post.terms.predefined.join('\n- ')}` : '';
                const custom = post.terms.custom ? `Términos personalizados:\n${post.terms.custom}` : '';
                const message = [predefined, custom].filter(Boolean).join('\n\n');
                alert(message || 'No hay términos y condiciones asociados a esta publicación.');
            } else {
                alert('No hay términos y condiciones asociados a esta publicación.');
            }
        });
        // FIN: LÓGICA INTEGRADA (Botón de Términos)

        // INICIO: LÓGICA INTEGRADA (Botón de Eliminar)
        if (post.autor === USER_ID) {
            const deleteButton = document.createElement('button');
            deleteButton.className = 'btn btn-sm btn-danger w-100 mt-2';
            deleteButton.id = `btn-delete-${post.id}`;
            deleteButton.textContent = '🗑️ Eliminar Publicación';
            deleteButton.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que quieres eliminar esta publicación?')) {
                    eliminarPost(post.id);
                }
            });
            container.appendChild(deleteButton);
        }
        // FIN: LÓGICA INTEGRADA (Botón de Eliminar)

        return container;
    }

    function toggleLike(postId) {
        let posts = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const postIndex = posts.findIndex(p => p.id === postId);
        if (postIndex === -1) return;

        const userIndex = posts[postIndex].likers.indexOf(USER_ID);
        if (userIndex > -1) {
            posts[postIndex].likers.splice(userIndex, 1);
            posts[postIndex].likes--;
        } else {
            posts[postIndex].likers.push(USER_ID);
            posts[postIndex].likes++;
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(posts));
        loadPosts();
    }

    function addComment(postId, text) {
        let posts = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const postIndex = posts.findIndex(p => p.id === postId);
        if (postIndex === -1) return;
        
        posts[postIndex].comentarios.push({ autor: USER_ID, texto: text });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(posts));
        loadPosts();
    }
    
    // INICIO: FUNCIÓN INTEGRADA
    function eliminarPost(postId) {
        let posts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        posts = posts.filter(post => post.id !== postId);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(posts));
        loadPosts();
    }
    // FIN: FUNCIÓN INTEGRADA

    function guardarPublicacion() {
        const texto = document.getElementById('post-text').value.trim();
        const privacidad = document.getElementById('privacidad').value;
        const archivo = document.getElementById('file-media').files[0];
        
        if (markers.length === 0) {
            alert("Debes seleccionar una ubicación en el mapa."); return;
        }
        if (!texto) {
            alert("El texto de la publicación no puede estar vacío."); return;
        }

        const latlngs = markers.map(m => m.getLatLng());
        
        const rutaInputs = document.querySelectorAll('#ruta-inputs input');
        const rutas = latlngs.map((latlng, i) => ({
            coords: `${latlng.lat},${latlng.lng}`,
            label: rutaInputs[i]?.value.trim() || `Punto de interés ${i + 1}`
        }));

        // INICIO: LÓGICA INTEGRADA (Guardar Términos)
        const customTerms = document.getElementById('custom-terms').value.trim();
        const predefinedTerms = [];
        if (document.getElementById('terms-weapons').checked) {
            predefinedTerms.push('Prohibición de armas');
        }
        if (document.getElementById('terms-illegal-substances').checked) {
            predefinedTerms.push('Prohibición de sustancias ilegales');
        }

        if (!customTerms && predefinedTerms.length === 0) {
            alert('Debes definir o seleccionar al menos un término o condición.');
            return;
        }
        // FIN: LÓGICA INTEGRADA (Guardar Términos)

        const newPost = {
            id: 'post_' + Date.now(),
            autor: USER_ID,
            username: USER_ID, // Añadido para consistencia
            texto,
            privacidad,
            mediaURL: '',
            ubicacion: `${latlngs[0].lat},${latlngs[0].lng}`,
            rutas: rutas,
            timestamp: new Date().toISOString(),
            likes: 0,
            likers: [],
            comentarios: [],
            terms: { custom: customTerms, predefined: predefinedTerms } // Añadido
        };

        if (archivo) {
            const reader = new FileReader();
            reader.onload = (e) => {
                newPost.mediaURL = e.target.result;
                guardarYActualizarFeed(newPost);
            };
            reader.readAsDataURL(archivo);
        } else {
            guardarYActualizarFeed(newPost);
        }
    }
    
    function guardarYActualizarFeed(post) {
        let posts = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        posts.push(post);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(posts));
        
        // Limpieza del formulario original
        document.getElementById('post-text').value = '';
        document.getElementById('file-media').value = '';
        document.getElementById('location-display').textContent = 'Ninguna ubicación seleccionada';
        document.getElementById('publish-button').disabled = true;

        // INICIO: LÓGICA INTEGRADA (Limpieza de formulario de Términos)
        document.getElementById('custom-terms').value = '';
        document.getElementById('terms-weapons').checked = false;
        document.getElementById('terms-illegal-substances').checked = false;
        // FIN: LÓGICA INTEGRADA (Limpieza de formulario de Términos)

        if(postPreviewMap) {
            postPreviewMap.remove();
            postPreviewMap = null;
            postMapPreviewContainer.style.height = '0px';
        }
        clearMap();
        loadPosts();
    }

    initExamplePosts();
    loadPosts();
    document.getElementById('publish-button').addEventListener('click', guardarPublicacion);

});

    // 1. Objeto con la definición de todos los temas
    const temas = {
        default: {
            headerBG: "linear-gradient(145deg, #007BFF, #003366)",
            headerText: "white",
            headerIconBG: "rgba(255, 255, 255, 0.15)",
            bodyBG: "#f0f2f5",
            sidebarBG: "linear-gradient(145deg, #007BFF, #003366)",
            sidebarText: "white",
            cardBG: "#ffffff",
            cardText: "#333",
            btnPrimaryBG: "#00bfff"
        },
        aurora: {
            headerBG: "linear-gradient(145deg, #F8CDDA, #1D2B64)",
            headerText: "#FFFFFF",
            headerIconBG: "rgba(255, 255, 255, 0.2)",
            bodyBG: "#fdeff2",
            sidebarBG: "linear-gradient(145deg, #1D2B64, #F8CDDA)",
            sidebarText: "#FFFFFF",
            cardBG: "#ffffff",
            cardText: "#1D2B64",
            btnPrimaryBG: "#1D2B64"
        },
        noche: {
            headerBG: "linear-gradient(145deg, #141E30, #243B55)",
            headerText: "white",
            headerIconBG: "rgba(255, 255, 255, 0.1)",
            bodyBG: "#0f172a",
            sidebarBG: "linear-gradient(145deg, #141E30, #243B55)",
            sidebarText: "white",
            cardBG: "#1e293b",
            cardText: "#e2e8f0",
            btnPrimaryBG: "#38bdf8"
        },
        oceano: {
            headerBG: "linear-gradient(145deg, #2C3E50, #4CA1AF)",
            headerText: "white",
            headerIconBG: "rgba(255, 255, 255, 0.15)",
            bodyBG: "#eef6f7",
            sidebarBG: "linear-gradient(145deg, #2C3E50, #4CA1AF)",
            sidebarText: "white",
            cardBG: "#ffffff",
            cardText: "#2C3E50",
            btnPrimaryBG: "#4CA1AF"
        },
        amanecer: {
            headerBG: "linear-gradient(145deg, #FF512F, #F09819)",
            headerText: "white",
            headerIconBG: "rgba(255, 255, 255, 0.2)",
            bodyBG: "#fff8f2",
            sidebarBG: "linear-gradient(145deg, #FF512F, #F09819)",
            sidebarText: "white",
            cardBG: "#ffffff",
            cardText: "#5c2a07",
            btnPrimaryBG: "#FF512F"
        },
        pastel: {
            headerBG: "linear-gradient(145deg, #A1C4FD, #C2E9FB)",
            headerText: "#003366",
            headerIconBG: "rgba(0, 51, 102, 0.1)",
            bodyBG: "#f5f9ff",
            sidebarBG: "linear-gradient(145deg, #A1C4FD, #C2E9FB)",
            sidebarText: "#003366",
            cardBG: "#ffffff",
            cardText: "#333",
            btnPrimaryBG: "#A1C4FD"
        },
        fuego: {
            headerBG: "linear-gradient(145deg, #CB356B, #BD3F32)",
            headerText: "white",
            headerIconBG: "rgba(255, 255, 255, 0.15)",
            bodyBG: "#f9f2f3",
            sidebarBG: "linear-gradient(145deg, #CB356B, #BD3F32)",
            sidebarText: "white",
            cardBG: "#ffffff",
            cardText: "#4d1024",
            btnPrimaryBG: "#CB356B"
        },
        bosque: {
            headerBG: "linear-gradient(145deg, #11998E, #38EF7D)",
            headerText: "white",
            headerIconBG: "rgba(255, 255, 255, 0.2)",
            bodyBG: "#f2fcf8",
            sidebarBG: "linear-gradient(145deg, #11998E, #38EF7D)",
            sidebarText: "white",
            cardBG: "#ffffff",
            cardText: "#043d38",
            btnPrimaryBG: "#11998E"
        },
        lluvia: {
            headerBG: "linear-gradient(145deg, #396afc, #2948ff)",
            headerText: "white",
            headerIconBG: "rgba(255, 255, 255, 0.1)",
            bodyBG: "#f0f2ff",
            sidebarBG: "linear-gradient(145deg, #396afc, #2948ff)",
            sidebarText: "white",
            cardBG: "#ffffff",
            cardText: "#192d8b",
            btnPrimaryBG: "#396afc"
        }
    };

    // 2. Función para aplicar el tema
    function applyTheme(themeName) {
        const root = document.documentElement;
        const theme = temas[themeName] || temas.noche; // Usar 'noche' como predeterminado si no se encuentra

        root.style.setProperty('--header-bg', theme.headerBG);
        root.style.setProperty('--header-text-color', theme.headerText);
        root.style.setProperty('--header-icon-bg', theme.headerIconBG);
        root.style.setProperty('--header-icon-hover-bg', `rgba(255, 255, 255, 0.25)`);

        root.style.setProperty('--body-bg', theme.bodyBG);
        
        root.style.setProperty('--sidebar-bg', theme.sidebarBG);
        root.style.setProperty('--sidebar-text-color', theme.sidebarText);
        root.style.setProperty('--sidebar-hover-bg', `rgba(255, 255, 255, 0.15)`);

        root.style.setProperty('--card-bg', theme.cardBG);
        root.style.setProperty('--card-text-color', theme.cardText);
        
        root.style.setProperty('--btn-primary-bg', theme.btnPrimaryBG);
        root.style.setProperty('--btn-primary-text', theme.headerText); // A menudo el texto del botón coincide con el del header
    }

    // 3. Obtener tema guardado y aplicarlo
    const savedTheme = localStorage.getItem('geoPlannerTema');
    if (savedTheme) {
        applyTheme(savedTheme);
    } else {
        applyTheme('default'); // Aplicar tema por defecto si no hay ninguno guardado
    }
    document.addEventListener("DOMContentLoaded", function() {
    const nombre = localStorage.getItem("geoPlannerNombre") || "Usuario";
    const apellido = localStorage.getItem("geoPlannerApellido") || "";
    const foto = localStorage.getItem("geoPlannerFotoPerfil");
    const tema = localStorage.getItem("geoPlannerTema") || "default";

    // Cambiar nombre en header o perfil
    document.querySelectorAll(".nombre-usuario").forEach(el => {
    el.textContent = `${nombre} ${apellido}`;
    });
    
    // Cambiar foto de perfil
    if (foto) {
        document.querySelectorAll(".foto-usuario").forEach(el => {
        el.src = foto;
        });
    }

    // Aplicar tema visual
    if (tema !== "default") {
        document.body.classList.add(`tema-${tema}`);
    }
    });

    
</script>
</body>
</html>