<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoPlanner - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --header-bg: linear-gradient(145deg, #007BFF, #003366);
            --header-text-color: white;
            --header-icon-bg: rgba(255, 255, 255, 0.15);
            --header-icon-hover-bg: rgba(255, 255, 255, 0.25);
            --body-bg: #f0f2f5;
            --sidebar-bg: linear-gradient(145deg, #007BFF, #003366);
            --sidebar-text-color: white;
            --sidebar-hover-bg: rgba(255, 255, 255, 0.15);
            --card-bg: #ffffff;
            --card-text-color: #333;
            --card-secondary-text-color: #6c757d;
            --btn-primary-bg: #0d6efd;
            --btn-primary-text: white;
            --verified-badge-color: #ffd700;
            --star-saved-color: #ffc107;
            --star-default-color: #adb5bd;
        }

        body {
            background-color: var(--body-bg);
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }

        body.classic-view-active .new-post-button {
            display: block;
        }

        body.classic-view-active .content-area {
            display: flex;
            justify-content: center;
        }

        header {
            background: var(--header-bg);
            color: var(--header-text-color);
            padding: 0.75rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 1050;
        }

        .main-content {
            display: flex;
            height: calc(100vh - 65px);
        }

        .left-sidebar {
            width: 250px;
            background: var(--sidebar-bg);
            color: var(--sidebar-text-color);
            padding: 1.5rem;
            height: 100%;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .left-sidebar ul {
            list-style: none;
            padding-left: 0;
        }

        .left-sidebar li {
            margin-bottom: 1rem;
            font-weight: 500;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .left-sidebar li:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .content-area {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            position: relative;
        }

        #map-view-container {
            display: flex;
            height: 100%;
            gap: 1.5rem;
        }

        #feed-map {
            flex-grow: 1;
            border-radius: 10px;
        }

        #event-detail-sidebar {
            width: 350px;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            transform: translateX(110%);
            transition: transform 0.4s ease;
            position: absolute;
            right: 1.5rem;
            top: 0;
            height: 100%;
        }

        #event-detail-sidebar.show {
            transform: translateX(0);
        }

        #classic-feed-container {
            display: none;
            width: 100%;
            justify-content: center;
        }

        #classic-feed-view {
            max-width: 700px;
            width: 100%;
        }

        .post {
            background-color: var(--card-bg);
            color: var(--card-text-color);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.05);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .geoplanner-verified-icon {
            width: 18px;
            height: 18px;
            color: var(--verified-badge-color);
            vertical-align: middle;
        }

        .save-star-icon {
            cursor: pointer;
            margin-left: auto;
            color: var(--star-default-color);
            transition: color 0.2s, transform 0.2s;
        }

        .save-star-icon.saved {
            color: var(--star-saved-color);
            transform: scale(1.2);
        }

        .post img {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }

        .map-container {
            height: 250px;
            border-radius: 10px;
            margin-top: 0.5rem;
        }

        .create-post-widget {
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.05);
        }

        .create-post-widget-input {
            flex-grow: 1;
            background-color: var(--body-bg);
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .create-post-widget-input:hover {
            background-color: #e4e6eb;
        }

        .new-post-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--btn-primary-bg);
            color: white;
            font-size: 2rem;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1040;
            display: none;
        }

        #location-display {
            border: 1px dashed #ccc;
            padding: 0.5rem;
            border-radius: 8px;
            min-height: 40px;
            background-color: #f8f9fa;
        }

        #modal-map-container {
            height: 50vh;
            border-radius: 10px;
        }

        .icon-bar {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 55px;
            background-color: var(--card-bg);
            color: var(--card-text-color);
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            width: 360px;
            z-index: 2000;
            border: 1px solid #ddd;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .dropdown-item-custom {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s;
            color: var(--card-text-color);
            text-decoration: none;
        }

        .dropdown-item-custom:hover {
            background-color: var(--body-bg);
        }

        .dropdown-item-custom img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .icon-button {
            background-color: var(--header-icon-bg);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--header-text-color);
        }

        .icon-button:hover {
            background-color: var(--header-icon-hover-bg);
        }

        .map-filters {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 401;
            background: white;
            padding: 0.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>

<body>

    <header class="d-flex justify-content-between align-items-center">
        <a href="dashboard.html" class="d-flex align-items-center gap-2 text-white text-decoration-none">
            <img src="img/LogoMini.png" alt="Logo" style="width: 36px;" />
            <strong class="fs-5">GeoPlanner</strong>
        </a>
        <div class="search-bar">
            <input type="text" class="form-control" placeholder="Buscar..." />
        </div>
        <div class="d-flex align-items-center gap-3">
            <button id="view-toggle-btn" class="btn btn-outline-light btn-sm">Ver Feed Cl√°sico</button>
            <div class="icon-bar d-flex gap-2">
                <span class="icon-button" id="requests-icon" title="Solicitudes de amistad">ü§ù</span>
                <div class="dropdown-content" id="requests-dropdown">
                    <div class="dropdown-header">Solicitudes de amistad</div>
                    <a href="#" class="dropdown-item-custom">
                        <img src="img/placeholder.png" alt="user">
                        <div>
                            <strong>Ana Rodriguez</strong> quiere ser tu amiga.
                            <div class="d-flex gap-2 mt-2">
                                <button class="btn btn-primary btn-sm">Aceptar</button>
                                <button class="btn btn-secondary btn-sm">Rechazar</button>
                            </div>
                        </div>
                    </a>
                </div>

                <span class="icon-button" id="notifications-icon" title="Notificaciones">üîî</span>
                <div class="dropdown-content" id="notifications-dropdown">
                    <div class="dropdown-header">Notificaciones</div>
                    <a href="#" class="dropdown-item-custom">
                        <img src="img/estudio.jpg" alt="event">
                        <div><strong>@carlos_martinez</strong> coment√≥ en tu publicaci√≥n.</div>
                    </a>
                </div>

                <span class="icon-button" id="profile-icon" title="Perfil">üë§</span>
                <div class="dropdown-content" id="profile-dropdown">
                    <a href="perfil.html" class="dropdown-item-custom">
                        <img class="foto-usuario" src="img/placeholder.png" alt="profile">
                        <div>
                            <span class="nombre-usuario">Usuario</span>
                            <svg class="geoplanner-verified-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm5.71,7.29-6,6a1,1,0,0,1-1.42,0l-3-3a1,1,0,0,1,1.42-1.42L11,13.59l5.29-5.3a1,1,0,0,1,1.42,1.42Z" />
                            </svg>
                            <br>
                            <small>Ver tu perfil</small>
                        </div>
                    </a>
                    <hr class="my-2">
                    <a href="index.html" class="dropdown-item-custom" id="logout-button">
                        <span>‚û°Ô∏è</span>
                        <div><strong>Cerrar sesi√≥n</strong></div>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="main-content">
        <aside class="left-sidebar">
            <ul>
                <li id="menu-agenda">üìÖ Mi Agenda</li>
                <li id="menu-inscripciones">üéüÔ∏è Mis Inscripciones</li>
                <li id="menu-guardados">‚≠ê Eventos Guardados</li>
                <li>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Grupos</li>
            </ul>
        </aside>

        <div class="content-area">
            <div id="map-view-container">
                <div id="feed-map">
                    <div class="map-filters">
                        <select id="map-filter-type" class="form-select form-select-sm">
                            <option value="all">Todos los tipos</option>
                            <option value="Deporte">Deporte</option>
                            <option value="Estudio">Estudio</option>
                            <option value="Social">Social</option>
                            <option value="Cultural">Cultural</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                </div>
                <div id="event-detail-sidebar"></div>
            </div>
            <div id="classic-feed-container">
                <div id="classic-feed-view">
                    <div class="create-post-widget">
                        <div class="d-flex align-items-center gap-2">
                            <img src="img/placeholder.png" class="foto-usuario" alt="user" style="width: 40px; height: 40px; border-radius: 50%;">
                            <div class="create-post-widget-input" data-bs-toggle="modal" data-bs-target="#create-post-modal">
                                ¬øQu√© est√°s organizando, <span class="nombre-usuario-short">Usuario</span>?
                            </div>
                        </div>
                    </div>
                    <div id="classic-feed-content"></div>
                </div>
            </div>
        </div>
    </div>

    <button class="new-post-button" data-bs-toggle="modal" data-bs-target="#create-post-modal">+</button>

    <!-- Modal: Crear Nueva Publicaci√≥n -->
    <div class="modal fade" id="create-post-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Crear Nueva Publicaci√≥n</h5>
                    <button class="btn btn-sm btn-outline-primary" id="generate-ideas-btn">Generar Ideas ‚ú®</button>
                </div>
                <div class="modal-body">
                    <form id="create-post-form">
                        <div class="input-group mb-3">
                            <textarea id="post-text" class="form-control" rows="3" placeholder="¬øQu√© est√°s organizando?..."></textarea>
                            <button class="btn btn-outline-secondary" type="button" id="enhance-text-btn" title="Mejorar texto con IA">‚ú®</button>
                        </div>
                        <div id="idea-suggestions" class="mb-3"></div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <select class="form-select" id="post-type">
                                    <option>Social</option>
                                    <option>Deporte</option>
                                    <option>Estudio</option>
                                    <option>Cultural</option>
                                    <option>Otro</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <input type="datetime-local" id="post-date" class="form-control">
                            </div>
                            <div class="col-md-4 mb-3">
                                <select class="form-select" id="post-privacy">
                                    <option value="publica">P√∫blica</option>
                                    <option value="amigos">Solo amigos</option>
                                    <option value="privada">Privada con invitaci√≥n</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <input type="file" id="file-media" class="form-control" accept="image/*" />
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="modal" data-bs-target="#map-select-modal">
                                üìç Seleccionar Ubicaci√≥n
                            </button>
                            <div id="location-display" class="mt-2">No se ha seleccionado ninguna ubicaci√≥n.</div>
                        </div>

                        <!-- SECCI√ìN DE T√âRMINOS Y CONDICIONES -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">T√©rminos y Condiciones del Evento</label>

                            <!-- Opci√≥n 1: T√©rminos Predeterminados -->
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="terms-option" id="terms-default-radio" value="default" checked>
                                <label class="form-check-label" for="terms-default-radio">
                                    Usar T√©rminos y Condiciones de GeoPlanner
                                </label>
                            </div>
                            <div class="p-2 mt-1 mb-2 border rounded bg-light" style="font-size: 0.8rem; max-height: 150px; overflow-y: auto;">
                                <strong>Al seleccionar esta opci√≥n, aceptas y aplicas los siguientes t√©rminos a tu evento:</strong>
                                <p class="mt-1 mb-0 small"><strong>1. Responsabilidad Exclusiva del Organizador:</strong> Usted es el √∫nico responsable de la legalidad, seguridad (permisos, control de multitudes, etc.) y contenido de su evento.</p>
                                <p class="mt-1 mb-0 small"><strong>2. Deslinde de GeoPlanner:</strong> GeoPlanner es solo una plataforma tecnol√≥gica y no se hace responsable por ning√∫n incidente, da√±o o consecuencia legal relacionada con el evento.</p>
                                <p class="mt-1 mb-0 small"><strong>3. Prohibiciones Estrictas:</strong> Se proh√≠ben terminantemente eventos con actividades ilegales, armas, sustancias il√≠citas, violencia o discursos de odio.</p>
                                <p class="mt-1 mb-0 small"><strong>4. Cooperaci√≥n con Autoridades:</strong> Al publicar, confirma que su identidad fue verificada y acepta que su informaci√≥n puede ser compartida con las autoridades si se detecta alguna ilegalidad.</p>
                                <p class="mt-1 mb-0 small"><strong>Al publicar, declara que ha le√≠do y aceptado estos t√©rminos.</strong></p>
                            </div>

                            <!-- Opci√≥n 2: T√©rminos Personalizados -->
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="terms-option" id="terms-custom-radio" value="custom">
                                <label class="form-check-label" for="terms-custom-radio">
                                    Usar T√©rminos y Condiciones Personalizados (Bajo tu propio riesgo)
                                </label>
                            </div>
                            <textarea id="custom-terms-textarea" class="form-control mt-2" rows="3" placeholder="Define tus propias reglas y condiciones. Recuerda que eres el √∫nico responsable legal de tu evento." style="display: none;"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="publish-button">Publicar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Seleccionar Ubicaci√≥n -->
    <div class="modal fade" id="map-select-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Define la ubicaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" data-bs-target="#create-post-modal" data-bs-toggle="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="simple-route-tab">üìç Ruta Simple</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="multiple-route-tab">‚ûØ Ruta M√∫ltiple</button>
                        </li>
                    </ul>
                    <p class="form-text mt-2">
                        <strong>Ruta Simple:</strong> Un √∫nico marcador.<br>
                        <strong>Ruta M√∫ltiple:</strong> Traza una ruta con varios puntos.
                    </p>
                    <div id="modal-map-container"></div>
                    <div id="ruta-inputs" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" id="clear-map-button">Limpiar Mapa</button>
                    <button type="button" class="btn btn-primary" id="accept-location-button">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Agenda -->
    <div class="modal fade" id="agenda-modal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mi Agenda Privada</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Nueva Actividad</h6>
                            <form id="agenda-form">
                                <div class="mb-2"><input type="text" id="agenda-title" class="form-control" placeholder="T√≠tulo de la actividad" required></div>
                                <div class="mb-2"><textarea id="agenda-desc" class="form-control" rows="3" placeholder="Descripci√≥n..."></textarea></div>
                                <div class="mb-2"><input type="datetime-local" id="agenda-date" class="form-control" required></div>
                                <button type="submit" class="btn btn-primary w-100">Guardar Actividad</button>
                            </form>
                        </div>
                        <div class="col-md-8">
                            <h6>Mis Actividades</h6>
                            <div id="agenda-list" class="list-group"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Eventos Guardados -->
    <div class="modal fade" id="saved-events-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mis Eventos Guardados</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="saved-events-list"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- GLOBAL VARIABLES & CONSTANTS ---
            const STORAGE_KEY_POSTS = 'geoplanner_posts';
            const STORAGE_KEY_AGENDA = 'geoplanner_agenda_';
            const STORAGE_KEY_SAVED = 'geoplanner_saved_';
            let currentUser = JSON.parse(sessionStorage.getItem('currentUser')) || {};
            const USER_ID = currentUser.nombreUsuario || 'invitado';

            let mainMap, selectionMap, selectionPolyline;
            let selectedMarkers = [];
            let routeType = 'simple';
            let currentView = 'map';
            let allPosts = [];
            let agendaItems = [];
            let savedEvents = [];

            const createPostModal = new bootstrap.Modal(document.getElementById('create-post-modal'));
            const agendaModal = new bootstrap.Modal(document.getElementById('agenda-modal'));
            const savedEventsModal = new bootstrap.Modal(document.getElementById('saved-events-modal'));

            // --- THEME LOGIC ---
            const temas = {
                default: {
                    headerBG: "linear-gradient(145deg, #007BFF, #003366)",
                    headerText: "white",
                    bodyBG: "#f0f2f5",
                    sidebarBG: "linear-gradient(145deg, #007BFF, #003366)",
                    sidebarText: "white",
                    cardBG: "#ffffff",
                    cardText: "#333",
                    btnPrimaryBG: "#00bfff"
                },
                aurora: {
                    headerBG: "linear-gradient(145deg, #F8CDDA, #1D2B64)",
                    headerText: "#FFFFFF",
                    bodyBG: "#fdeff2",
                    sidebarBG: "linear-gradient(145deg, #F8CDDA, #1D2B64)",
                    sidebarText: "#FFFFFF",
                    cardBG: "#ffffff",
                    cardText: "#1D2B64",
                    btnPrimaryBG: "#1D2B64"
                },
                noche: {
                    headerBG: "linear-gradient(145deg, #141E30, #243B55)",
                    headerText: "white",
                    bodyBG: "#0f172a",
                    sidebarBG: "linear-gradient(145deg, #141E30, #243B55)",
                    sidebarText: "white",
                    cardBG: "#1e293b",
                    cardText: "#e2e8f0",
                    btnPrimaryBG: "#38bdf8"
                },
                oceano: {
                    headerBG: "linear-gradient(145deg, #2C3E50, #4CA1AF)",
                    headerText: "white",
                    bodyBG: "#eef6f7",
                    sidebarBG: "linear-gradient(145deg, #2C3E50, #4CA1AF)",
                    sidebarText: "white",
                    cardBG: "#ffffff",
                    cardText: "#2C3E50",
                    btnPrimaryBG: "#4CA1AF"
                },
                amanecer: {
                    headerBG: "linear-gradient(145deg, #FF512F, #F09819)",
                    headerText: "white",
                    bodyBG: "#fff8f2",
                    sidebarBG: "linear-gradient(145deg, #FF512F, #F09819)",
                    sidebarText: "white",
                    cardBG: "#ffffff",
                    cardText: "#5c2a07",
                    btnPrimaryBG: "#FF512F"
                },
                pastel: {
                    headerBG: "linear-gradient(145deg, #A1C4FD, #C2E9FB)",
                    headerText: "#003366",
                    bodyBG: "#f5f9ff",
                    sidebarBG: "linear-gradient(145deg, #A1C4FD, #C2E9FB)",
                    sidebarText: "#003366",
                    cardBG: "#ffffff",
                    cardText: "#333",
                    btnPrimaryBG: "#A1C4FD"
                },
                fuego: {
                    headerBG: "linear-gradient(145deg, #CB356B, #BD3F32)",
                    headerText: "white",
                    bodyBG: "#f9f2f3",
                    sidebarBG: "linear-gradient(145deg, #CB356B, #BD3F32)",
                    sidebarText: "white",
                    cardBG: "#ffffff",
                    cardText: "#4d1024",
                    btnPrimaryBG: "#CB356B"
                },
                bosque: {
                    headerBG: "linear-gradient(145deg, #11998E, #38EF7D)",
                    headerText: "white",
                    bodyBG: "#f2fcf8",
                    sidebarBG: "linear-gradient(145deg, #11998E, #38EF7D)",
                    sidebarText: "white",
                    cardBG: "#ffffff",
                    cardText: "#043d38",
                    btnPrimaryBG: "#11998E"
                },
                lluvia: {
                    headerBG: "linear-gradient(145deg, #396afc, #2948ff)",
                    headerText: "white",
                    bodyBG: "#f0f2ff",
                    sidebarBG: "linear-gradient(145deg, #396afc, #2948ff)",
                    sidebarText: "white",
                    cardBG: "#ffffff",
                    cardText: "#192d8b",
                    btnPrimaryBG: "#396afc"
                }
            };

            // 2. Funci√≥n para aplicar el tema
            function applyTheme(themeName) {
                const root = document.documentElement;
                const theme = temas[themeName] || temas.noche; // Usar 'noche' como predeterminado si no se encuentra

                root.style.setProperty('--header-bg', theme.headerBG);
                root.style.setProperty('--header-text-color', theme.headerText);
                root.style.setProperty('--header-icon-bg', theme.headerIconBG);
                root.style.setProperty('--header-icon-hover-bg', `rgba(255, 255, 255, 0.25)`);

                root.style.setProperty('--body-bg', theme.bodyBG);
                
                root.style.setProperty('--sidebar-bg', theme.sidebarBG);
                root.style.setProperty('--sidebar-text-color', theme.sidebarText);
                root.style.setProperty('--sidebar-hover-bg', `rgba(255, 255, 255, 0.15)`);

                root.style.setProperty('--card-bg', theme.cardBG);
                root.style.setProperty('--card-text-color', theme.cardText);
                
                root.style.setProperty('--btn-primary-bg', theme.btnPrimaryBG);
                root.style.setProperty('--btn-primary-text', theme.headerText); // A menudo el texto del bot√≥n coincide con el del header
            }

            // 3. Obtener tema guardado y aplicarlo
            const savedTheme = localStorage.getItem('geoPlannerTema');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                applyTheme('default'); // Aplicar tema por defecto si no hay ninguno guardado
            }

            // --- DATA INITIALIZATION & MANAGEMENT ---
            function initData() {
                // Cargar y mostrar datos del usuario desde localStorage
                const nombre = localStorage.getItem("geoPlannerNombre") || "Usuario";
                const apellido = localStorage.getItem("geoPlannerApellido") || "";
                const foto = localStorage.getItem("geoPlannerFotoPerfil");
                const tema = localStorage.getItem("geoPlannerTema") || "default";

                // Actualizar el objeto currentUser para la l√≥gica interna (como USER_ID)
                currentUser.nombre = `${nombre} ${apellido}`.trim();
                currentUser.foto = foto;

                // Actualizar nombre en el perfil y en el widget de creaci√≥n
                document.querySelector('.nombre-usuario').textContent = currentUser.nombre;
                document.querySelector('.nombre-usuario-short').textContent = nombre.split(' ')[0];

                // Actualizar foto de perfil en todos los elementos relevantes
                if (foto) {
                    document.querySelectorAll(".foto-usuario").forEach(el => {
                        el.src = foto;
                    });
                }

                // Cargar publicaciones, agenda y eventos guardados
                const examplePosts = [{
                    id: 'post_1',
                    author: 'ana_gomez',
                    verified: true,
                    text: '¬°Ma√±ana de senderismo en la monta√±a! Salimos a las 7 AM.',
                    privacidad: 'publica',
                    mediaURL: 'https://images.unsplash.com/photo-1551632811-561732d1e306?q=80&w=2070',
                    type: 'Deporte',
                    eventDate: '2025-07-15T07:00:00',
                    likes: 15,
                    likers: [],
                    comentarios: [{
                        author: 'carlos_ruiz',
                        text: '¬°All√° nos vemos!'
                    }],
                    rutas: [{
                        coords: '10.72,-71.65',
                        label: 'Entrada principal'
                    }],
                    terms: {
                        type: 'default',
                        text: ''
                    }
                }, {
                    id: 'post_8',
                    author: 'juan_sarcos',
                    verified: true,
                    text: '¬°Vamos al cine a ver el estreno del verano!',
                    privacidad: 'amigos',
                    mediaURL: 'https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=1975',
                    type: 'Social',
                    eventDate: '2025-08-02T20:00:00',
                    likes: 9,
                    likers: [USER_ID],
                    comentarios: [],
                    rutas: [{
                        coords: '10.69,-71.63',
                        label: 'Cinex Galer√≠as'
                    }],
                    terms: {
                        type: 'custom',
                        text: 'Comprar entradas con antelaci√≥n. Ser puntuales por favor.'
                    }
                }];
                if (!localStorage.getItem(STORAGE_KEY_POSTS)) {
                    localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(examplePosts));
                }
                allPosts = JSON.parse(localStorage.getItem(STORAGE_KEY_POSTS));
                agendaItems = JSON.parse(localStorage.getItem(STORAGE_KEY_AGENDA + USER_ID)) || [];
                savedEvents = JSON.parse(localStorage.getItem(STORAGE_KEY_SAVED + USER_ID)) || [];

                // Aplicar el tema guardado
                applyTheme(tema);
            }

            // --- VIEW MANAGEMENT & RENDERING ---
            function toggleView() {
                currentView = (currentView === 'map') ? 'classic' : 'map';
                document.getElementById('view-toggle-btn').textContent = currentView === 'map' ? 'Ver Feed Cl√°sico' : 'Ver Vista de Mapa';
                document.getElementById('map-view-container').style.display = currentView === 'map' ? 'flex' : 'none';
                document.getElementById('classic-feed-container').style.display = currentView === 'classic' ? 'flex' : 'none';
                if (currentView === 'map') {
                    mainMap.invalidateSize();
                } else {
                    renderClassicFeed();
                }
            }

            function renderClassicFeed() {
                const feedContent = document.getElementById('classic-feed-content');
                feedContent.innerHTML = '';
                allPosts
                    .sort((a, b) => new Date(b.eventDate) - new Date(a.eventDate))
                    .forEach(post => feedContent.appendChild(renderPost(post)));
            }

            function renderPost(post) {
                const container = document.createElement('div');
                container.className = 'post';

                const privacyBadge = {
                    publica: 'üîì P√∫blica',
                    amigos: 'üë• Amigos',
                    privada: 'üîí Privada'
                } [post.privacidad] || 'üîì P√∫blica';
                const isLiked = post.likers.includes(USER_ID);
                const isSaved = savedEvents.includes(post.id);
                const verifiedIcon = `<svg class="geoplanner-verified-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm5.71,7.29-6,6a1,1,0,0,1-1.42,0l-3-3a1,1,0,0,1,1.42-1.42L11,13.59l5.29-5.3a1,1,0,0,1,1.42,1.42Z"/></svg>`;
                const saveStarIcon = `<svg class="save-star-icon ${isSaved ? 'saved' : ''}" data-post-id="${post.id}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;

                container.innerHTML = `
                    <div class="post-header">
                        <strong>${post.author}</strong>
                        ${post.verified ? verifiedIcon : ''}
                        <span class="badge bg-secondary">${privacyBadge}</span>
                        ${saveStarIcon}
                    </div>
                    <p>${post.text}</p>
                    ${post.mediaURL ? `<img src="${post.mediaURL}" alt="Media" class="img-fluid rounded mb-2" onerror="this.style.display='none'">` : ''}
                    <div class="map-container mb-2" id="map-${post.id}"></div>
                    ${post.rutas.length > 1 ? `<ol class="list-group list-group-flush list-group-numbered mb-2 small">${post.rutas.map(r => `<li class="list-group-item">${r.label}</li>`).join('')}</ol>` : ''}
                    <div class="d-flex gap-2 mt-2 flex-wrap">
                        <button class="btn btn-sm btn-outline-danger btn-like" data-post-id="${post.id}">
                            ${isLiked ? 'üíî Quitar Like' : '‚ù§Ô∏è Like'} (<span>${post.likes}</span>)
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#comentarios-${post.id}">
                            üí¨ Comentarios (${post.comentarios.length})
                        </button>
                        <button class="btn btn-sm btn-outline-info btn-terms" data-post-id="${post.id}">
                            üìú Ver T√©rminos
                        </button>
                    </div>
                    <div class="comentarios mt-2 collapse" id="comentarios-${post.id}">
                        <div class="comentarios-list mb-2 small">
                            ${post.comentarios.map(c => `<div><strong>@${c.author}:</strong> ${c.text}</div>`).join('') || 'No hay comentarios.'}
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control form-control-sm" placeholder="Escribe un comentario...">
                            <button class="btn btn-sm btn-primary btn-comment" data-post-id="${post.id}">Enviar</button>
                        </div>
                    </div>
                `;

                if (post.author === USER_ID) {
                    container.innerHTML += `<button class="btn btn-sm btn-danger w-100 mt-2 btn-delete" data-post-id="${post.id}">üóëÔ∏è Eliminar Publicaci√≥n</button>`;
                }

                setTimeout(() => {
                    const mapElement = container.querySelector(`#map-${post.id}`);
                    if (mapElement && !mapElement.classList.contains('leaflet-container')) {
                        const latlngs = post.rutas.map(r => r.coords.split(',').map(Number));
                        const postMap = L.map(mapElement, {
                            zoomControl: false,
                            scrollWheelZoom: false
                        }).setView(latlngs[0], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(postMap);
                        latlngs.forEach(latlng => L.marker(latlng).addTo(postMap));
                        if (latlngs.length > 1) {
                            const polyline = L.polyline(latlngs, {
                                color: '#007BFF'
                            }).addTo(postMap);
                            postMap.fitBounds(polyline.getBounds(), {
                                padding: [20, 20]
                            });
                        } else {
                            postMap.setView(latlngs[0], 15);
                        }
                    }
                }, 0);
                return container;
            }

            function renderSavedPost(post) {
                const container = document.createElement('div');
                container.className = 'post';
                container.innerHTML = `
                    <p>${post.text}</p>
                    <div class="map-container mb-2" id="map-saved-${post.id}"></div>
                `;
                setTimeout(() => {
                    const mapElement = container.querySelector(`#map-saved-${post.id}`);
                    if (mapElement && !mapElement.classList.contains('leaflet-container')) {
                        const latlngs = post.rutas.map(r => r.coords.split(',').map(Number));
                        const postMap = L.map(mapElement, {
                            zoomControl: false,
                            scrollWheelZoom: false
                        }).setView(latlngs[0], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(postMap);
                        latlngs.forEach(latlng => L.marker(latlng).addTo(postMap));
                        if (latlngs.length > 1) {
                            const polyline = L.polyline(latlngs, {
                                color: '#007BFF'
                            }).addTo(postMap);
                            postMap.fitBounds(polyline.getBounds(), {
                                padding: [20, 20]
                            });
                        } else {
                            postMap.setView(latlngs[0], 15);
                        }
                    }
                }, 0);
                return container;
            }

            function refreshUI() {
                renderClassicFeed();
                renderMapMarkers(document.getElementById('map-filter-type').value);
            }

            // --- INTERACTION LOGIC ---
            function toggleLike(postId) {
                const post = allPosts.find(p => p.id === postId);
                if (!post) return;
                const userIndex = post.likers.indexOf(USER_ID);
                if (userIndex > -1) {
                    post.likers.splice(userIndex, 1);
                    post.likes--;
                } else {
                    post.likers.push(USER_ID);
                    post.likes++;
                }
                localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(allPosts));
                refreshUI();
            }

            function addComment(postId, text) {
                const post = allPosts.find(p => p.id === postId);
                if (post && text) {
                    post.comentarios.push({
                        author: USER_ID,
                        text: text
                    });
                    localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(allPosts));
                    refreshUI();
                }
            }

            function eliminarPost(postId) {
                allPosts = allPosts.filter(p => p.id !== postId);
                localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(allPosts));
                refreshUI();
            }

            function toggleSaveEvent(postId) {
                const index = savedEvents.indexOf(postId);
                if (index > -1) {
                    savedEvents.splice(index, 1);
                } else {
                    savedEvents.push(postId);
                }
                localStorage.setItem(STORAGE_KEY_SAVED + USER_ID, JSON.stringify(savedEvents));
                refreshUI();
            }

            // --- MAPS & MODALS LOGIC ---
            function initMainMap() {
                mainMap = L.map('feed-map').setView([10.654, -71.612], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mainMap);
            }

            function renderMapMarkers(filterType = 'all') {
                const markerColors = {
                    'Deporte': 'orange',
                    'Estudio': 'blue',
                    'Social': 'green',
                    'Cultural': 'purple',
                    'Otro': 'grey'
                };
                mainMap.eachLayer(layer => {
                    if (layer instanceof L.Marker) mainMap.removeLayer(layer);
                });
                const filteredPosts = (filterType === 'all') ? allPosts : allPosts.filter(p => p.type === filterType);
                filteredPosts.forEach(post => {
                    if (post.rutas && post.rutas.length > 0) {
                        const latlng = post.rutas[0].coords.split(',').map(Number);
                        const icon = L.divIcon({
                            html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"><path fill="${markerColors[post.type] || 'red'}" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>`,
                            className: 'dummy',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32]
                        });
                        const marker = L.marker(latlng, {
                            icon
                        }).addTo(mainMap);
                        marker.on('mouseover', () => marker.bindPopup(`<b>${post.text.substring(0,30)}...</b>`).openPopup());
                        marker.on('click', () => {
                            const detailSidebar = document.getElementById('event-detail-sidebar');
                            detailSidebar.innerHTML = `<div class="post">${renderPost(post).innerHTML}</div>`;
                            detailSidebar.classList.add('show');
                        });
                    }
                });
            }

            function renderAgenda() {
                const list = document.getElementById('agenda-list');
                list.innerHTML = agendaItems.length ? '' : '<p>No tienes actividades en tu agenda.</p>';
                agendaItems
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'list-group-item';
                        itemEl.innerHTML = `
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${item.title}</h6>
                                <small>${new Date(item.date).toLocaleDateString()}</small>
                            </div>
                            <p class="mb-1">${item.desc}</p>
                            <div id="steps-${item.id}" class="mt-2"></div>
                            <button class="btn btn-sm btn-outline-primary btn-suggest" data-item-id="${item.id}">Sugerir Pasos ‚ú®</button>
                            <button class="btn btn-sm btn-outline-danger float-end btn-delete-agenda" data-item-id="${item.id}">Eliminar</button>
                        `;
                        list.appendChild(itemEl);
                    });
            }

            function renderSavedEvents() {
                const container = document.getElementById('saved-events-list');
                container.innerHTML = '';
                const savedPosts = allPosts.filter(post => savedEvents.includes(post.id));
                if (savedPosts.length === 0) {
                    container.innerHTML = '<p class="p-3">No tienes eventos guardados.</p>';
                } else {
                    savedPosts.forEach(post => container.appendChild(renderSavedPost(post)));
                }
                savedEventsModal.show();
            }

            function savePost() {
                const text = document.getElementById('post-text').value.trim();
                if (!text || selectedMarkers.length === 0) {
                    alert("El texto de la publicaci√≥n y la ubicaci√≥n son obligatorios.");
                    return;
                }

                const termsOption = document.querySelector('input[name="terms-option"]:checked').value;
                const customText = document.getElementById('custom-terms-textarea').value.trim();

                if (termsOption === 'custom' && !customText) {
                    alert("Si eliges usar t√©rminos personalizados, el campo no puede estar vac√≠o.");
                    return;
                }

                const postTerms = {
                    type: termsOption,
                    text: termsOption === 'custom' ? customText : ''
                };

                const latlngs = selectedMarkers.map(m => m.getLatLng());
                const rutaInputs = document.querySelectorAll('#ruta-inputs input');
                const newPost = {
                    id: 'post_' + Date.now(),
                    author: USER_ID,
                    verified: currentUser.verified || false,
                    text: text,
                    privacidad: document.getElementById('post-privacy').value,
                    mediaURL: '',
                    type: document.getElementById('post-type').value,
                    eventDate: document.getElementById('post-date').value,
                    status: 'vigente',
                    likes: 0,
                    likers: [],
                    comentarios: [],
                    rutas: latlngs.map((latlng, i) => ({
                        coords: `${latlng.lat},${latlng.lng}`,
                        label: (rutaInputs[i] && rutaInputs[i].value.trim()) || `Punto ${i + 1}`
                    })),
                    terms: postTerms
                };

                const file = document.getElementById('file-media').files[0];
                const updateAndRefresh = (post) => {
                    allPosts.unshift(post);
                    localStorage.setItem(STORAGE_KEY_POSTS, JSON.stringify(allPosts));
                    document.getElementById('create-post-form').reset();
                    document.getElementById('location-display').textContent = 'No se ha seleccionado ninguna ubicaci√≥n.';
                    document.getElementById('custom-terms-textarea').style.display = 'none';
                    selectedMarkers = [];
                    createPostModal.hide();
                    refreshUI();
                };

                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        newPost.mediaURL = e.target.result;
                        updateAndRefresh(newPost);
                    };
                    reader.readAsDataURL(file);
                } else {
                    updateAndRefresh(newPost);
                }
            }


            // --- EVENT LISTENERS SETUP ---
            function setupEventListeners() {
                document.getElementById('view-toggle-btn').addEventListener('click', toggleView);
                document.getElementById('publish-button').addEventListener('click', savePost);
                document.getElementById('map-filter-type').addEventListener('change', (e) => renderMapMarkers(e.target.value));
                document.querySelector('.create-post-widget-input').addEventListener('click', () => createPostModal.show());
                document.querySelector('.new-post-button').addEventListener('click', () => createPostModal.show());
                document.getElementById('menu-agenda').addEventListener('click', () => {
                    renderAgenda();
                    agendaModal.show();
                });
                document.getElementById('menu-guardados').addEventListener('click', renderSavedEvents);

                const dropdownIcons = {
                    'requests-icon': 'requests-dropdown',
                    'notifications-icon': 'notifications-dropdown',
                    'profile-icon': 'profile-dropdown'
                };
                const closeAllDropdowns = () => Object.values(dropdownIcons).forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.remove('show');
                });
                Object.keys(dropdownIcons).forEach(iconId => {
                    const icon = document.getElementById(iconId);
                    const dropdown = document.getElementById(dropdownIcons[iconId]);
                    if (icon && dropdown) {
                        icon.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const isShown = dropdown.classList.contains('show');
                            closeAllDropdowns();
                            if (!isShown) dropdown.classList.add('show');
                        });
                    }
                });
                window.addEventListener('click', closeAllDropdowns);

                document.getElementById('classic-feed-content').addEventListener('click', (e) => {
                    const button = e.target.closest('button, .save-star-icon');
                    if (!button) return;
                    const postId = button.dataset.postId;
                    if (!postId) return;
                    if (button.classList.contains('btn-like')) toggleLike(postId);
                    if (button.classList.contains('btn-delete'))
                        if (confirm('¬øEst√°s seguro de que quieres eliminar esta publicaci√≥n?')) eliminarPost(postId);
                    if (button.classList.contains('btn-comment')) {
                        const commentInput = button.previousElementSibling;
                        addComment(postId, commentInput.value);
                        commentInput.value = '';
                    }
                    if (button.classList.contains('btn-terms')) {
                        const post = allPosts.find(p => p.id === postId);
                        if (post && post.terms) {
                            let termsContent = '';
                            const defaultTermsText =
                                `T√âRMINOS Y CONDICIONES PREDETERMINADOS DE GEOPLANNER\n\n` +
                                `1. Aceptaci√≥n de los T√©rminos:\nAl crear y publicar un evento en GeoPlanner, usted (en adelante, "el Organizador") acepta y se compromete a cumplir en su totalidad los siguientes t√©rminos y condiciones.\n\n` +
                                `2. Responsabilidad Exclusiva del Organizador:\nEl Organizador es el √∫nico y exclusivo responsable de todos los aspectos del evento, incluyendo pero no limit√°ndose a:\n- Legalidad y Permisos: Asegurar que el evento cumple con todas las leyes y obtener todos los permisos necesarios.\n- Seguridad: Garantizar la seguridad de todos los asistentes y del lugar.\n- Contenido y Actividades: El contenido y las actividades durante el evento son su responsabilidad.\n\n` +
                                `3. Deslinde de Responsabilidad de GeoPlanner:\nGeoPlanner es una plataforma tecnol√≥gica que facilita la conexi√≥n y NO organiza, supervisa, ni controla los eventos. Por lo tanto, GeoPlanner se exime de toda responsabilidad por cualquier da√±o, p√©rdida, lesi√≥n o consecuencia legal que surja del evento.\n\n` +
                                `4. Prohibiciones Estrictas:\nEst√° terminantemente prohibido organizar eventos que involucren o fomenten:\n- Actividades Ilegales.\n- Armas y Explosivos.\n- Sustancias Il√≠citas.\n- Violencia, Discursos de Odio o Discriminaci√≥n.\n\n` +
                                `5. Verificaci√≥n de Identidad y Cooperaci√≥n con la Ley:\nUsted reconoce que su identidad fue verificada. En caso de reportarse una actividad il√≠cita, GeoPlanner cooperar√° con las autoridades y podr√° proporcionarles su informaci√≥n.\n\n` +
                                `Al publicar un evento, usted declara haber le√≠do, comprendido y aceptado estos t√©rminos en su totalidad.`;

                            if (post.terms.type === 'default') {
                                termsContent = defaultTermsText;
                            } else if (post.terms.type === 'custom') {
                                termsContent = `T√âRMINOS PERSONALIZADOS (BAJO RESPONSABILIDAD DEL ORGANIZADOR):\n\n${post.terms.text}`;
                            } else {
                                const predefined = post.terms.predefined && post.terms.predefined.length > 0 ? `T√©rminos predefinidos:\n- ${post.terms.predefined.join('\n- ')}` : '';
                                const custom = post.terms.custom ? `T√©rminos personalizados:\n${post.terms.custom}` : '';
                                termsContent = [predefined, custom].filter(Boolean).join('\n\n');
                            }

                            alert(termsContent || 'No hay t√©rminos especificados para este evento.');
                        }
                    }
                    if (button.classList.contains('save-star-icon')) toggleSaveEvent(postId);
                });

                document.getElementById('agenda-modal').addEventListener('click', async (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const itemId = button.dataset.itemId;
                    if (button.classList.contains('btn-delete-agenda')) {
                        agendaItems = agendaItems.filter(i => i.id !== itemId);
                        localStorage.setItem(STORAGE_KEY_AGENDA + USER_ID, JSON.stringify(agendaItems));
                        renderAgenda();
                    }
                    if (button.classList.contains('btn-suggest')) {
                        const item = agendaItems.find(i => i.id === itemId);
                        if (!item) return;
                        const prompt = `Para la actividad "${item.title}" programada para el ${item.date}, genera una lista de 5 a 7 pasos o tareas clave para su organizaci√≥n. Responde solo con los pasos, separados por comas.`;
                        const result = await callGeminiAPI(prompt, button);
                        if (result) {
                            const stepsHtml = result.split(',').map(step => `<li class="list-group-item list-group-item-light py-1">${step.trim()}</li>`).join('');
                            document.getElementById(`steps-${itemId}`).innerHTML = `<ul class="list-group mt-2">${stepsHtml}</ul>`;
                        }
                    }
                });
                document.getElementById('agenda-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newItem = {
                        id: 'agenda_' + Date.now(),
                        title: document.getElementById('agenda-title').value,
                        desc: document.getElementById('agenda-desc').value,
                        date: document.getElementById('agenda-date').value,
                    };
                    agendaItems.unshift(newItem);
                    localStorage.setItem(STORAGE_KEY_AGENDA + USER_ID, JSON.stringify(agendaItems));
                    renderAgenda();
                    e.target.reset();
                });

                const mapSelectModalEl = document.getElementById('map-select-modal');
                mapSelectModalEl.addEventListener('shown.bs.modal', function() {
                    if (!selectionMap) {
                        selectionMap = L.map('modal-map-container').setView([10.654, -71.612], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(selectionMap);
                        selectionMap.on('click', (e) => {
                            if (routeType === 'simple' && selectedMarkers.length > 0) clearSelectionMap();
                            const newMarker = L.marker(e.latlng).addTo(selectionMap);
                            selectedMarkers.push(newMarker);
                            if (routeType === 'multiple' && selectedMarkers.length > 1) {
                                if (selectionPolyline) selectionMap.removeLayer(selectionPolyline);
                                selectionPolyline = L.polyline(selectedMarkers.map(m => m.getLatLng()), {
                                    color: '#007BFF'
                                }).addTo(selectionMap);
                            }
                        });
                    }
                    setTimeout(() => selectionMap.invalidateSize(), 10);
                });
                const clearSelectionMap = () => {
                    selectedMarkers.forEach(m => selectionMap.removeLayer(m));
                    selectedMarkers = [];
                    if (selectionPolyline) {
                        selectionMap.removeLayer(selectionPolyline);
                        selectionPolyline = null;
                    }
                };
                document.getElementById('clear-map-button').addEventListener('click', clearSelectionMap);
                document.getElementById('simple-route-tab').addEventListener('click', () => {
                    routeType = 'simple';
                    clearSelectionMap();
                });
                document.getElementById('multiple-route-tab').addEventListener('click', () => {
                    routeType = 'multiple';
                    clearSelectionMap();
                });
                document.getElementById('accept-location-button').addEventListener('click', () => {
                    if (selectedMarkers.length > 0) {
                        const latlngs = selectedMarkers.map(m => m.getLatLng());
                        document.getElementById('location-display').textContent = routeType === 'simple' ? `Ubicaci√≥n: [${latlngs[0].lat.toFixed(4)}, ${latlngs[0].lng.toFixed(4)}]` : `Ruta M√∫ltiple (${selectedMarkers.length} puntos)`;
                        bootstrap.Modal.getInstance(mapSelectModalEl).hide();
                    } else {
                        alert("Por favor, selecciona al menos un punto.");
                    }
                });

                const termsDefaultRadio = document.getElementById('terms-default-radio');
                const termsCustomRadio = document.getElementById('terms-custom-radio');
                const customTermsTextarea = document.getElementById('custom-terms-textarea');

                termsDefaultRadio.addEventListener('change', () => {
                    if (termsDefaultRadio.checked) {
                        customTermsTextarea.style.display = 'none';
                    }
                });

                termsCustomRadio.addEventListener('change', () => {
                    if (termsCustomRadio.checked) {
                        customTermsTextarea.style.display = 'block';
                    }
                });
            }

            async function callGeminiAPI(prompt, button) {
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Respuesta no v√°lida de la API.");
                    }
                } catch (error) {
                    console.error("Error con API de Gemini:", error);
                    alert("Hubo un error al contactar a la IA.");
                    return null;
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            // --- INITIALIZATION ---
            function initialize() {
                initData();
                initMainMap();
                renderMapMarkers();
                setupEventListeners();
                renderClassicFeed();
            }

            initialize();
        });
    </script>
</body>

</html>
